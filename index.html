<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <title>PO Wizard - Film Production Invoice Processing</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        body {
            background-color: #F8FAFC;
            font-family: 'Inter', 'Noto Sans', sans-serif;
        }
        .po-wizard-title-font {
            font-family: 'Poppins', sans-serif;
        }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07); }

        .progress-section { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.5s ease-in-out; }
        .progress-section.expanded { max-height: 800px; opacity: 1; margin-top: 2rem; }

        .pdf-preview { background: #ffffff; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .pdf-preview:hover { border-color: #06B6D4; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .pdf-preview.approved { border-color: #34d399; background: #f0fdf4; }

        .tab-button.active { background: #06B6D4; color: white; }
        .btn-primary, .btn-accent {
            background-color: #06B6D4;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover, .btn-accent:hover {
            background-color: #0891B2;
        }
        .iframe-container { position: relative; overflow: hidden; width: 100%; padding-top: 141.42%; /* A4 Aspect Ratio */ }
        .iframe-container iframe { position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; border: none; }

        .relevant-docs-viewer { /* Renamed from backup-docs-viewer */
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        .relevant-docs-viewer img { /* Renamed from backup-docs-viewer */
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: block; /* Ensure img is block for proper layout */
            margin-bottom: 0.5rem;
        }
         .relevant-docs-viewer .doc-item {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .relevant-docs-viewer .doc-item p {
            margin-bottom: 0.25rem;
        }


        .review-modal-content-area {
            min-height: 60vh;
            max-height: 70vh; 
            display: flex;
            flex-direction: column;
        }
        .review-modal-fixed-buttons {
            position: sticky;
            bottom: 0;
            background-color: white;
            padding-top: 1rem;
            padding-bottom: 1.5rem;
            border-top: 1px solid #e2e8f0;
            margin-top: auto;
        }
    </style>
</head>
<body class="bg-slate-50 font-['Inter','Noto_Sans',sans-serif]">
    <div class="min-h-screen flex flex-col">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
            <div class="w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-3 h-20 md:h-auto md:py-4">
                    <a href="#" onclick="showTab('hero'); if(typeof closeMobileMenu === 'function') closeMobileMenu();" class="flex items-center cursor-pointer">
                        <img src="assets/POWizard.png" alt="PO Wizard Logo" class="h-10 w-auto mr-2 sm:mr-3 md:h-12">
                        <div class="flex flex-col justify-center">
                            <span class="po-wizard-title-font block text-2xl sm:text-3xl font-bold text-cyan-700 leading-tight">PO Wizard</span>
                            <span class="block text-xs text-slate-500 leading-tight mt-[-2px] sm:mt-0">Built for Production</span>
                        </div>
                    </a>
                    <div id="desktopMenu" class="hidden md:flex items-center space-x-3 lg:space-x-4">
                        <nav class="flex items-center space-x-1 lg:space-x-3">
                            <button onclick="showTab('features')" class="tab-button px-3 py-2 rounded-lg text-sm lg:text-base text-slate-700 hover:text-cyan-600 hover:bg-cyan-50">Features</button>
                            <button onclick="showTab('pricing')" class="tab-button px-3 py-2 rounded-lg text-sm lg:text-base text-slate-700 hover:text-cyan-600 hover:bg-cyan-50">Pricing</button>
                            <button onclick="showTab('purchaseOrders')" id="processingNavButton" class="tab-button px-3 py-2 rounded-lg text-sm lg:text-base text-slate-700 hover:text-cyan-600 hover:bg-cyan-50 whitespace-nowrap">My POs / Process</button>
                        </nav>
                        <div class="flex items-center space-x-2 lg:space-x-3 border-l border-slate-300 pl-3 lg:pl-4">
                            <div id="authActionsUnauthenticated_desktop">
                                <button onclick="signInWithGoogle()" class="btn-primary whitespace-nowrap px-3 lg:px-4 py-2 rounded-lg font-medium text-sm lg:text-base">
                                    Sign In with Google
                                </button>
                            </div>
                            <div id="authActionsAuthenticated_desktop" class="hidden items-center space-x-3">
                                <span id="userDisplayName_desktop" class="text-sm text-slate-700"></span>
                                <button onclick="signOut()" class="px-3 py-2 rounded-lg text-sm lg:text-base text-slate-700 hover:text-cyan-600 hover:bg-cyan-50">Sign Out</button>
                            </div>
                        </div>
                    </div>
                    <div class="md:hidden">
                        <button id="mobileMenuButton" class="text-slate-600 hover:text-cyan-700 focus:outline-none p-2">
                            <span class="material-icons-outlined text-3xl">menu</span>
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobileMenu" class="md:hidden hidden bg-white border-t border-slate-200 shadow-lg absolute w-full z-40">
                <nav class="flex flex-col space-y-1 p-4">
                    <button onclick="showTab('features'); toggleMobileMenu();" class="tab-button block px-3 py-3 rounded-lg text-slate-700 hover:text-cyan-700 hover:bg-cyan-50 text-left text-base">Features</button>
                    <button onclick="showTab('pricing'); toggleMobileMenu();" class="tab-button block px-3 py-3 rounded-lg text-slate-700 hover:text-cyan-700 hover:bg-cyan-50 text-left text-base">Pricing</button>
                    <button onclick="showTab('purchaseOrders'); toggleMobileMenu();" id="mobileProcessingNavButton" class="tab-button block px-3 py-3 rounded-lg text-slate-700 hover:text-cyan-700 hover:bg-cyan-50 text-left text-base">My POs / Process</button>
                    <hr class="my-2"/>
                    <div id="authActionsUnauthenticated_mobile">
                        <button onclick="signInWithGoogle(); toggleMobileMenu();" class="block w-full text-center btn-primary px-3 py-3 rounded-lg font-medium text-base">
                            Sign In with Google
                        </button>
                    </div>
                    <div id="authActionsAuthenticated_mobile" class="hidden flex flex-col space-y-2">
                        <span id="userDisplayName_mobile" class="block px-3 py-2 text-slate-700 text-center text-base"></span>
                        <button onclick="signOut(); toggleMobileMenu();" class="block w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-3 rounded-lg font-medium text-base">
                            Sign Out
                        </button>
                    </div>
                </nav>
            </div>
        </header>

        <main class="flex-1">
            <section id="heroSection" class="bg-white py-16 lg:py-20">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h2 class="po-wizard-title-font text-5xl lg:text-6xl font-bold text-cyan-700 mb-8 leading-tight">
                            Stop Wrestling with<br/>
                            <span class="text-cyan-500">Post-Production Receipts</span>
                        </h2>
                        <p class="text-xl lg:text-2xl text-slate-700 max-w-4xl mx-auto leading-relaxed mb-12">
                            Transform your chaotic pile of vendor invoices, receipts, and credit card statements into professional purchase orders in minutes, not hours. Built specifically for <strong>production coordinators</strong> tired of manual PO creation.
                        </p>
                        <div class="grid md:grid-cols-2 gap-12 max-w-5xl mx-auto mb-16">
                            <div class="bg-white rounded-2xl p-8 shadow-lg border border-slate-200">
                                <div class="text-red-500 mb-4"><span class="material-icons-outlined text-4xl">warning</span></div>
                                <h3 class="po-wizard-title-font text-xl font-bold text-slate-800 mb-4">The Old Way</h3>
                                <ul class="text-slate-700 space-y-2 text-left">
                                    <li>• Hours manually entering vendor data</li><li>• Hunting through receipts and invoices</li><li>• Formatting POs one by one</li><li>• Missing deadlines for production companies</li><li>• Losing track of expenses</li>
                                </ul>
                            </div>
                            <div class="bg-white rounded-2xl p-8 shadow-lg border border-slate-200">
                                <div class="text-green-500 mb-4"><span class="material-icons-outlined text-4xl">auto_awesome</span></div>
                                <h3 class="po-wizard-title-font text-xl font-bold text-slate-800 mb-4">The PO Wizard Way</h3>
                                <ul class="text-slate-700 space-y-2 text-left">
                                    <li>• AI scans all your documents automatically</li><li>• Extracts vendor info, amounts, dates</li><li>• Generates professional POs instantly</li><li>• Ready for production company submission</li><li>• Complete audit trail maintained</li>
                                </ul>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-6">
                            <button onclick="handleGetStartedClick('free')" class="btn-accent font-bold py-4 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-300 text-lg">
                                Start Free Trial - Process 5 Vendors
                            </button>
                            <button onclick="showTab('features')" class="bg-cyan-50 hover:bg-cyan-100 text-cyan-700 font-semibold py-4 px-8 rounded-xl transition-all duration-200 border border-cyan-200">
                                See How It Works
                            </button>
                        </div>
                        <p class="text-slate-500 mt-6 text-sm">Sign in to start • 2-minute setup • Works with any production size</p>
                    </div>
                    <div class="text-center">
                        <p class="text-slate-600 text-sm mb-6">Trusted by Production Coordinators at:</p>
                        <div class="flex justify-center items-center space-x-12 opacity-80">
                            <div class="text-slate-700 font-bold text-lg">Netflix</div><div class="text-slate-700 font-bold text-lg">HBO</div><div class="text-slate-700 font-bold text-lg">Warner Bros</div><div class="text-slate-700 font-bold text-lg">A24</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="featuresSection" class="py-20 bg-slate-100 hidden">
                 <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h3 class="po-wizard-title-font text-4xl font-bold text-cyan-700 mb-6">How PO Wizard Works</h3>
                        <p class="text-xl text-slate-700 max-w-3xl mx-auto">Three simple steps to transform your post-production chaos into organized, professional purchase orders</p>
                    </div>
                    <div class="grid lg:grid-cols-3 gap-12 mb-20">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-cyan-100 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-3xl font-bold text-cyan-700">1</span></div>
                            <h4 class="po-wizard-title-font text-xl font-bold text-slate-800 mb-4">Upload Your Mess</h4>
                            <p class="text-slate-600 mb-6">Connect your Dropbox or upload folders full of vendor invoices, receipts, credit card statements, and random charges from your production.</p>
                            <div class="bg-white rounded-xl p-6">
                                <div class="flex justify-center space-x-4 mb-4">
                                    <div class="w-12 h-16 bg-red-100 rounded border-2 border-red-200 flex items-center justify-center"><span class="material-icons-outlined text-red-600 text-sm">receipt</span></div>
                                    <div class="w-12 h-16 bg-blue-100 rounded border-2 border-blue-200 flex items-center justify-center"><span class="material-icons-outlined text-blue-600 text-sm">description</span></div>
                                    <div class="w-12 h-16 bg-green-100 rounded border-2 border-green-200 flex items-center justify-center"><span class="material-icons-outlined text-green-600 text-sm">credit_card</span></div>
                                </div><p class="text-xs text-slate-500">Invoices, receipts, credit card statements</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="w-20 h-20 bg-cyan-100 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-3xl font-bold text-cyan-700">2</span></div>
                            <h4 class="po-wizard-title-font text-xl font-bold text-slate-800 mb-4">AI Works Its Magic</h4>
                            <p class="text-slate-600 mb-6">Our AI scans every document, extracts vendor information, amounts, dates, and categories. No manual data entry required.</p>
                            <div class="bg-white rounded-xl p-6">
                                <div class="flex justify-center mb-4"><div class="w-16 h-16 bg-gradient-to-br from-cyan-500 to-sky-500 rounded-full flex items-center justify-center"><span class="material-icons-outlined text-white text-2xl">psychology</span></div></div>
                                <div class="space-y-2"><div class="h-2 bg-gradient-to-r from-cyan-300 to-sky-300 rounded animate-pulse"></div><div class="h-2 bg-gradient-to-r from-sky-300 to-cyan-300 rounded animate-pulse" style="animation-delay: 0.5s"></div><div class="h-2 bg-gradient-to-r from-cyan-300 to-sky-300 rounded animate-pulse" style="animation-delay: 1s"></div></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-3xl font-bold text-green-700">3</span></div>
                            <h4 class="po-wizard-title-font text-xl font-bold text-slate-800 mb-4">Perfect POs Delivered</h4>
                            <p class="text-slate-600 mb-6">Get professionally formatted purchase orders ready for production company submission. Review, approve, and download in minutes.</p>
                            <div class="bg-white rounded-xl p-6">
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="h-20 bg-white rounded-lg border-2 border-green-300 p-2"><div class="h-2 bg-green-300 rounded mb-1"></div><div class="h-2 bg-green-100 rounded mb-1"></div><div class="h-2 bg-green-100 rounded"></div><div class="text-xs text-green-700 mt-2 font-medium">PO-001</div></div>
                                    <div class="h-20 bg-white rounded-lg border-2 border-green-300 p-2"><div class="h-2 bg-green-300 rounded mb-1"></div><div class="h-2 bg-green-100 rounded mb-1"></div><div class="h-2 bg-green-100 rounded"></div><div class="text-xs text-green-700 mt-2 font-medium">PO-002</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <div class="text-center floating-benefit"><div class="w-16 h-16 bg-sky-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-sky-600 text-2xl">schedule</span></div><h4 class="font-bold text-slate-800 mb-2">Save 10+ Hours</h4><p class="text-slate-600 text-sm">Per production wrap</p></div>
                        <div class="text-center floating-benefit" style="animation-delay: 1s"><div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-green-600 text-2xl">check_circle</span></div><h4 class="font-bold text-slate-800 mb-2">99% Accuracy</h4><p class="text-slate-600 text-sm">AI-powered extraction</p></div>
                        <div class="text-center floating-benefit" style="animation-delay: 2s"><div class="w-16 h-16 bg-cyan-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-cyan-700 text-2xl">trending_up</span></div><h4 class="font-bold text-slate-800 mb-2">Faster Payments</h4><p class="text-slate-600 text-sm">Professional formatting</p></div>
                        <div class="text-center floating-benefit" style="animation-delay: 3s"><div class="w-16 h-16 bg-slate-200 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-slate-600 text-2xl">security</span></div><h4 class="font-bold text-slate-800 mb-2">Audit Trail</h4><p class="text-slate-600 text-sm">Complete documentation</p></div>
                    </div>
                </div>
            </section>

            <section id="pricingSection" class="py-20 bg-white hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h3 class="po-wizard-title-font text-4xl font-bold text-cyan-700 mb-6">Simple, Transparent Pricing</h3>
                        <p class="text-xl text-slate-700 max-w-3xl mx-auto">Choose the plan that fits your production workflow. Start free, upgrade as you grow.</p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                        <div class="pricing-card bg-white rounded-2xl p-8 shadow-lg border border-slate-200">
                            <div class="text-center mb-8"><h4 class="po-wizard-title-font text-2xl font-bold text-slate-800 mb-2">Free</h4><p class="text-slate-600 mb-6">Perfect for small productions</p><div class="text-4xl font-bold text-slate-800 mb-2">Free</div><p class="text-slate-500 text-sm">Requires Google Sign-In</p></div>
                            <ul class="space-y-4 mb-8">
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Up to 5 vendors per production</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Single production processing</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Basic AI scanning</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Standard PO templates</span></li>
                            </ul><button onclick="handleGetStartedClick('free')" class="w-full bg-cyan-50 hover:bg-cyan-100 text-cyan-700 font-semibold py-3 px-6 rounded-xl transition-colors">Get Started Free</button>
                        </div>
                        <div class="pricing-card popular bg-white rounded-2xl p-8 shadow-xl relative">
                            <div class="absolute -top-4 left-1/2 transform -translate-x-1/2"><span class="bg-cyan-500 text-white px-4 py-1 rounded-full text-sm font-medium">Most Popular</span></div>
                            <div class="text-center mb-8"><h4 class="po-wizard-title-font text-2xl font-bold text-slate-800 mb-2">Pro</h4><p class="text-slate-600 mb-6">For growing productions</p><div class="text-4xl font-bold text-slate-800 mb-2">$20</div><p class="text-slate-500 text-sm">per month</p></div>
                            <ul class="space-y-4 mb-8">
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited vendors</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited production amounts</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited iterations on 1 production</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Advanced AI with 99% accuracy</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Custom PO templates</span></li>
                            </ul><button onclick="handleGetStartedClick('pro')" class="w-full btn-accent font-semibold py-3 px-6 rounded-xl">Start Free Trial</button>
                        </div>
                        <div class="pricing-card bg-white rounded-2xl p-8 shadow-lg border border-slate-200">
                            <div class="text-center mb-8"><h4 class="po-wizard-title-font text-2xl font-bold text-slate-800 mb-2">Enterprise</h4><p class="text-slate-600 mb-6">For production companies</p><div class="text-4xl font-bold text-slate-800 mb-2">$30</div><p class="text-slate-500 text-sm">per month</p></div>
                            <ul class="space-y-4 mb-8">
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited productions</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited vendors</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Cross-tracking between productions</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Microsoft Excel integration</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Fully custom, unbranded designs</span></li>
                            </ul><button onclick="handleGetStartedClick('enterprise')" class="w-full btn-primary font-semibold py-3 px-6 rounded-xl">Contact Sales</button>
                        </div>
                    </div>
                    <div class="text-center mt-12">
                        <p class="text-slate-600 mb-4">All plans include 14-day free trial (requires sign-in) • No setup fees • Cancel anytime</p>
                        <div class="flex justify-center items-center space-x-6 text-sm text-slate-500">
                            <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">security</span>Bank-grade security</span>
                            <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">support</span>24/7 support</span>
                            <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">cloud_upload</span>99.9% uptime</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="processingSection" class="bg-slate-100 py-16 lg:py-20 hidden">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <div class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8 lg:p-12 max-w-4xl mx-auto">
                        <div id="jobContextDisplay_processing" class="mb-6 text-cyan-700">Processing Job: <span id="displayJobNumber_processing" class="font-semibold">N/A</span> | Project: <span id="displayProjectName_processing" class="font-semibold">N/A</span></div>
                        <div class="flex justify-center items-center space-x-4 sm:space-x-8 mb-12">
                             <div id="tokenStepIndicator" class="flex flex-col items-center text-xs sm:text-sm"><div class="w-10 h-10 sm:w-12 sm:h-12 bg-slate-300 rounded-full flex items-center justify-center text-slate-500 font-bold text-lg mb-2 sm:mb-3 transition-all duration-300">1</div><span class="font-medium text-slate-500">Connect</span></div>
                             <div id="configureStepIndicator" class="flex flex-col items-center text-xs sm:text-sm"><div class="w-10 h-10 sm:w-12 sm:h-12 bg-slate-300 rounded-full flex items-center justify-center text-slate-500 font-bold text-lg mb-2 sm:mb-3 transition-all duration-300">2</div><span class="font-medium text-slate-500">Configure</span></div>
                             <div id="processDocsStepIndicator" class="flex flex-col items-center text-xs sm:text-sm"><div class="w-10 h-10 sm:w-12 sm:h-12 bg-slate-300 rounded-full flex items-center justify-center text-slate-500 font-bold text-lg mb-2 sm:mb-3 transition-all duration-300">3</div><span class="font-medium text-slate-500">Process</span></div>
                        </div>

                        <div id="step0_token_input" class="step-content hidden">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 bg-cyan-100 rounded-3xl flex items-center justify-center mx-auto mb-6">
                                    <span class="material-icons-outlined text-cyan-700 text-4xl">vpn_key</span>
                                </div>
                                <h3 class="po-wizard-title-font text-2xl font-bold text-slate-800 mb-4">Connect to Dropbox</h3>
                                <p class="text-slate-600 max-w-lg mx-auto mb-8">Please enter your Dropbox Generated Access Token to allow PO Wizard to access your files. This token is temporary and used for this session only.</p>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="dropboxAccessTokenInput" class="block text-sm font-medium text-slate-700 text-left mb-1">Dropbox Access Token:</label>
                                    <input type="password" id="dropboxAccessTokenInput" placeholder="Paste your token here" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                </div>
                            </div>
                            <button onclick="submitDropboxToken()" id="submitTokenButton" class="w-full btn-primary font-semibold py-4 px-8 rounded-xl transition-all">Submit Token & Continue</button>
                            <p class="text-xs text-slate-500 mt-2">Need help generating a token? <a href="#" class="text-cyan-600 hover:underline" onclick="alert('Help for token generation will be here.')">Click here</a>.</p>
                        </div>

                        <div id="step1_configure_job" class="step-content hidden">
                            <div class="text-center mb-8"><div class="w-20 h-20 bg-cyan-100 rounded-3xl flex items-center justify-center mx-auto mb-6"><svg class="w-10 h-10 text-cyan-700" fill="currentColor" viewBox="0 0 24 24"><path d="M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.015-3.569-1.156-.503.325-.808.817-.808 1.331 0 .694.521 1.304 1.25 1.304.188 0 .375-.047.551-.132l.812.812c-.387.226-.808.363-1.25.363-1.279 0-2.344-1.117-2.344-2.5 0-.691.279-1.328.775-1.791.871-.814 2.079-1.076 3.146-.805l1.397-1.397c.094-.094.219-.156.344-.156.281 0 .531.219.531.5 0 .125-.062.25-.156.344l-8.687 8.687c-.094.094-.219.156-.344-.156-.281 0-.531-.219-.531-.5 0-.125.062.25.156.344l3.344-3.344z"/></svg></div>
                                <h3 class="po-wizard-title-font text-2xl font-bold text-slate-800 mb-4">Configure Job & Paths</h3>
                                <p class="text-slate-600 max-w-lg mx-auto mb-8">Enter your Job Number, Project Name, and Dropbox paths. Your POs will be linked to your account.</p>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div><label for="inputJobNumber" class="block text-sm font-medium text-slate-700 text-left mb-1">Job Number:</label><input type="text" id="inputJobNumber" placeholder="e.g., 85319" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                                <div><label for="inputProjectName" class="block text-sm font-medium text-slate-700 text-left mb-1">Project Name:</label><input type="text" id="inputProjectName" placeholder="e.g., Macy's Holiday Shoot" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                                <div><label for="dropboxSourcePath" class="block text-sm font-medium text-slate-700 text-left mb-1">Dropbox Source Path (Vendor Folders):</label><input type="text" id="dropboxSourcePath" value="/POWizardCompany/SourceDocs" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                                <div><label for="dropboxOutputPath" class="block text-sm font-medium text-slate-700 text-left mb-1">Dropbox Output Path (Generated POs):</label><input type="text" id="dropboxOutputPath" value="/POWizardCompany/OutputPOs" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                            </div>
                            <button onclick="confirmPathsAndProceed()" id="confirmPathsButton" class="w-full btn-primary font-semibold py-4 px-8 rounded-xl transition-all">Confirm Paths & Proceed to Process</button>
                            <div class="text-xs text-slate-500 text-center mt-4"><span class="material-icons-outlined text-green-600 text-sm mr-1">lock</span>Secure connection via backend.</div>
                        </div>

                        <div id="step2_processing_docs" class="step-content hidden">
                             <div class="text-center mb-8"><div class="w-20 h-20 bg-green-100 rounded-3xl flex items-center justify-center mx-auto mb-6"><span class="material-icons-outlined text-green-700 text-3xl">auto_awesome</span></div>
                                <h3 class="po-wizard-title-font text-2xl font-bold text-slate-800 mb-4">Processing Documents...</h3>
                                <p class="text-slate-600 max-w-lg mx-auto mb-8" id="processingStatusText">AI is scanning your Dropbox folder, extracting data, and generating purchase orders. This may take several minutes depending on the number of documents.</p>
                            </div>
                            <div id="progressSection" class="progress-section">
                                <div class="border-t border-slate-200 pt-8">
                                    <div class="mb-6">
                                        <div class="w-full h-3 bg-slate-200 rounded-full overflow-hidden"><div id="progressFill" class="h-full bg-gradient-to-r from-green-500 to-cyan-500 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div>
                                        <div class="flex justify-between items-center mt-3"><span id="progressPercent" class="text-sm font-semibold text-slate-700">0%</span><span id="estimatedTime" class="text-xs text-slate-500">Calculating...</span></div>
                                    </div>
                                    <div class="bg-slate-100 rounded-xl p-6 text-center">
                                        <div class="flex items-center justify-center space-x-2 mb-3"><h4 id="stageTitle" class="text-lg font-semibold text-cyan-700">Initializing...</h4><div id="stageSpinner" class="w-4 h-4 border-2 border-slate-300 border-t-cyan-600 rounded-full animate-spin"></div></div>
                                        <p id="stageDescription" class="text-slate-600 text-sm">Preparing to process your documents.</p>
                                    </div>
                                    <button onclick="cancelProcessing()" id="cancelProcessingButton" class="mt-6 w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-3 px-6 rounded-xl transition-colors duration-200">Cancel Processing (Not Implemented)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="purchaseOrdersSection" class="py-16 bg-white hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center mb-8">
                        <div><h3 class="po-wizard-title-font text-3xl font-bold text-cyan-700 mb-2">My Purchase Orders</h3><p class="text-slate-600" id="currentJobDisplayPOs_dashboard">Job: <span id="displayJobNumber_dashboard">N/A</span> | Project: <span id="displayProjectName_dashboard">N/A</span></p></div>
                        <div class="flex items-center space-x-4">
                            <span id="poCount" class="text-sm text-slate-600">0 POs Generated</span>
                            <button onclick="promptForDropboxToken()" class="btn-primary px-4 py-2 rounded-lg font-medium text-sm">
                                <span class="flex items-center space-x-2"><span class="material-icons-outlined text-sm">add_circle_outline</span><span>New PO Batch</span></span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-slate-100 rounded-xl p-4 mb-8 flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center space-x-4"><select id="filterStatus" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-cyan-500 focus:border-cyan-500"><option value="all">All Status</option><option value="pending">Pending Review</option><option value="approved">Approved</option></select><input type="text" id="filterVendorName" placeholder="Filter by Vendor Name..." class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-cyan-500 focus:border-cyan-500"></div>
                        <div class="flex items-center space-x-2"><span class="text-sm text-slate-600">Sort by:</span><select id="sortPOs" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-cyan-500 focus:border-cyan-500"><option value="date">Date Created</option><option value="vendor">Vendor Name</option><option value="amount">Amount</option><option value="status">Status</option></select></div>
                    </div>
                    <div id="poGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
                    <div id="noPOsActionContainer" class="text-center py-12 hidden">
                        <span class="material-icons-outlined text-6xl text-slate-300 mb-4">folder_open</span>
                        <p id="noPOsMessage" class="text-slate-500 text-lg mb-6">No Purchase Orders found. Get started by creating a new batch.</p>
                        <button onclick="promptForDropboxToken()" class="btn-primary py-3 px-8 rounded-lg font-medium text-lg">
                            Create New PO Batch
                        </button>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center space-x-4 mt-12 hidden"><button class="p-2 hover:bg-cyan-50 rounded-lg transition-colors"><span class="material-icons-outlined">chevron_left</span></button><div class="flex space-x-1"><button class="px-3 py-2 bg-cyan-600 text-white rounded-lg">1</button></div><button class="p-2 hover:bg-cyan-50 rounded-lg transition-colors"><span class="material-icons-outlined">chevron_right</span></button></div>
                </div>
            </section>
        </main>

        <footer class="bg-slate-800 text-slate-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center space-x-3 mb-4 md:mb-0">
                         <img src="assets/POWizard.png" alt="PO Wizard Logo" class="h-8 w-auto filter brightness-0 invert">
                        <span class="po-wizard-title-font font-bold text-lg text-white">PO Wizard</span><span class="text-slate-400 text-sm">for Film Production</span>
                    </div>
                    <div class="text-center"><p class="text-slate-400 text-sm">Streamlining post-production workflows since 2024</p></div>
                </div>
            </div>
        </footer>
    </div>

    <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[100]">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-6xl w-11/12 md:w-full mx-auto flex flex-col max-h-[95vh] overflow-hidden">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 id="reviewModalTitle" class="po-wizard-title-font text-2xl font-bold text-cyan-700">Review Purchase Order</h3>
                <button onclick="closeReviewModal()" class="text-slate-400 hover:text-slate-600"><span class="material-icons-outlined text-2xl">close</span></button>
            </div>

            <div class="flex items-center space-x-2 mb-4 flex-shrink-0 border-b pb-2">
                <button id="viewPoPdfButton" onclick="showReviewContent('pdf', currentEditingPODataForModal)" class="btn-primary px-3 py-1.5 text-sm rounded-md">View PO PDF</button>
                <button id="viewRelevantDocsButton" onclick="showReviewContent('relevantDocs', currentEditingPODataForModal)" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1.5 text-sm rounded-md">View Relevant Documents</button>
            </div>

            <div class="flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-8 flex-grow overflow-y-auto review-modal-content-area">
                <div id="pdfDisplayArea" class="w-full lg:w-1/2 iframe-container">
                    <iframe id="pdfViewer" src="about:blank" title="PO PDF"></iframe>
                    <p id="pdfViewerFallbackMessage" class="text-xs text-slate-500 mt-1 text-center hidden">If PDF doesn't display, it may have started downloading. Check your browser downloads.</p>
                </div>
                <div id="relevantDocsDisplayArea" class="w-full lg:w-1/2 relevant-docs-viewer hidden">
                    <p class="text-center text-slate-500">Loading relevant documents...</p>
                </div>

                <div class="w-full lg:w-1/2 lg:max-h-full overflow-y-auto pr-2">
                    <form id="reviewForm" class="space-y-4">
                        <input type="hidden" id="editPoIdOnGrid"><input type="hidden" id="editOriginalPoPackageFilename"><input type="hidden" id="editBackupDocsPaths" name="backup_document_original_dropbox_paths">
                        <div><label for="editPoNumber" class="block text-sm font-medium text-slate-700 mb-1">PO Number</label><input type="text" id="editPoNumber" name="po_number" class="w-full form-input focus:ring-cyan-500 focus:border-cyan-500" readonly></div>
                        <div><label for="editVendor" class="block text-sm font-medium text-slate-700 mb-1">Vendor Name</label><input type="text" id="editVendor" name="vendor_name" class="w-full form-input focus:ring-cyan-500 focus:border-cyan-500"></div>
                        <div><label for="editVendorAddress" class="block text-sm font-medium text-slate-700 mb-1">Vendor Address</label><textarea id="editVendorAddress" name="vendor_address" rows="2" class="w-full form-textarea focus:ring-cyan-500 focus:border-cyan-500"></textarea></div>
                        <div class="grid grid-cols-2 gap-4"><div><label for="editVendorTIN" class="block text-sm font-medium text-slate-700 mb-1">Vendor TIN/SSN</label><input type="text" id="editVendorTIN" name="vendor_tin" class="w-full form-input focus:ring-cyan-500 focus:border-cyan-500"></div><div><label for="editPoDate" class="block text-sm font-medium text-slate-700 mb-1">PO Date (MM/DD/YY)</label><input type="text" id="editPoDate" name="po_date" class="w-full form-input focus:ring-cyan-500 focus:border-cyan-500"></div></div>
                         <div class="grid grid-cols-2 gap-4"><div><label for="editHasW9" class="block text-sm font-medium text-slate-700 mb-1">W9 on File?</label><select id="editHasW9" name="has_w9_document" class="w-full form-select focus:ring-cyan-500 focus:border-cyan-500"><option value="true">Yes</option><option value="false">No</option></select></div><div><label for="editIsIncorp" class="block text-sm font-medium text-slate-700 mb-1">Incorporated?</label><select id="editIsIncorp" name="is_incorp_on_w9" class="w-full form-select focus:ring-cyan-500 focus:border-cyan-500"><option value="Unknown">Unknown</option><option value="Yes">Yes</option><option value="No">No</option></select></div></div>
                        <div><label for="editInvoiceRef" class="block text-sm font-medium text-slate-700 mb-1">Invoice Reference(s)</label><input type="text" id="editInvoiceRef" name="invoice_reference_from_po" class="w-full form-input focus:ring-cyan-500 focus:border-cyan-500"></div>
                        <h4 class="text-md font-semibold text-cyan-700 pt-2">Line Items:</h4>
                        <div id="editLineItemsContainer" class="space-y-2 max-h-40 overflow-y-auto border p-2 rounded-md border-cyan-200"></div>
                        <button type="button" onclick="addLineItemField()" class="text-sm text-cyan-600 hover:text-cyan-800">+ Add Line Item</button>
                        <div><label for="editTotalAmount" class="block text-sm font-medium text-slate-700 mb-1">Total Amount ($)</label><input type="text" id="editTotalAmount" name="total_vendor_amount_str" class="w-full form-input focus:ring-cyan-500 focus:border-cyan-500"></div>
                        <div><label for="editAdditionalNotes" class="block text-sm font-medium text-slate-700 mb-1">Additional Notes</label><textarea id="editAdditionalNotes" name="additional_notes" rows="2" class="w-full form-textarea focus:ring-cyan-500 focus:border-cyan-500"></textarea></div>
                        <input type="hidden" id="editJobNumber" name="job_number"><input type="hidden" id="editProjectName" name="project_name">
                    </form>
                </div>
            </div>
            <div class="review-modal-fixed-buttons flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-auto pt-4 flex-shrink-0">
                <button onclick="submitPOChanges(false)" class="flex-1 btn-primary py-3 px-6 rounded-xl font-medium">Save Changes & Regenerate PO</button>
                <button onclick="submitPOChanges(true)" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-xl font-medium">Approve PO (Future)</button>
                <button onclick="closeReviewModal()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 px-6 rounded-xl font-medium">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://po-wizard-backend-private.onrender.com/api/v1';

        let isAuthenticated = false;
        let currentJobNumberContext = "";
        let currentProjectNameContext = "";
        let dropboxAccessToken = "";
        let currentOpenPOTaskId = null;
        let statusPollInterval = null;
        let allFetchedPOs = [];
        let currentUser = null;
        let currentEditingPODataForModal = null;

        function updateAuthUI() {
            const unauthDesktop = document.getElementById('authActionsUnauthenticated_desktop');
            const authDesktop = document.getElementById('authActionsAuthenticated_desktop');
            const userDisplayDesktop = document.getElementById('userDisplayName_desktop');
            const unauthMobile = document.getElementById('authActionsUnauthenticated_mobile');
            const authMobile = document.getElementById('authActionsAuthenticated_mobile');
            const userDisplayMobile = document.getElementById('userDisplayName_mobile');
            const procNavButton = document.getElementById('processingNavButton');
            const mobileProcNavButton = document.getElementById('mobileProcessingNavButton');

            if (isAuthenticated && currentUser) {
                unauthDesktop.classList.add('hidden');
                authDesktop.classList.remove('hidden');
                authDesktop.classList.add('flex');
                userDisplayDesktop.textContent = `Welcome, ${currentUser.displayName}!`;

                unauthMobile.classList.add('hidden');
                authMobile.classList.remove('hidden');
                authMobile.style.display = 'flex';
                authMobile.classList.add('flex-col', 'space-y-2');
                userDisplayMobile.textContent = `Welcome, ${currentUser.displayName}!`;

                procNavButton.textContent = 'My POs';
                mobileProcNavButton.textContent = 'My POs';
                procNavButton.disabled = false;
                mobileProcNavButton.disabled = false;
            } else {
                unauthDesktop.classList.remove('hidden');
                authDesktop.classList.add('hidden');
                authDesktop.classList.remove('flex');

                unauthMobile.classList.remove('hidden');
                authMobile.classList.add('hidden');
                authMobile.style.display = 'none';

                procNavButton.textContent = 'My POs / Process';
                mobileProcNavButton.textContent = 'My POs / Process';
                procNavButton.disabled = true;
                mobileProcNavButton.disabled = true;
            }
        }

        function signInWithGoogle() {
            console.log("Redirecting to backend for Google Sign-In...");
            window.location.href = `${API_BASE_URL}/auth/google/login`;
        }

        function handleGetStartedClick(plan) {
            console.log("handleGetStartedClick called with plan:", plan);
            if (isAuthenticated && currentUser) {
                console.log("User already authenticated. Proceeding to create new PO batch.");
                promptForDropboxToken();
            } else {
                console.log("User not authenticated. Initiating Google Sign-In.");
                signInWithGoogle();
            }
            if (typeof event !== 'undefined' && event && event.target && event.target.closest('#mobileMenu')) {
                 const mobileMenu = document.getElementById('mobileMenu');
                 if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                    toggleMobileMenu();
                }
            }
        }

        function signOut() {
            localStorage.removeItem('app_token');
            localStorage.removeItem('user_displayName');
            localStorage.removeItem('user_email');
            isAuthenticated = false;
            currentUser = null;
            currentJobNumberContext = "";
            currentProjectNameContext = "";
            dropboxAccessToken = "";
            allFetchedPOs = [];
            updateAuthUI();
            showTab('hero');
            if (document.getElementById('mobileMenu') && !document.getElementById('mobileMenu').classList.contains('hidden')) {
                toggleMobileMenu();
            }
            console.log("User signed out.");
        }

        async function fetchUserDetails(token) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        console.warn("fetchUserDetails: Token validation failed (401). Signing out.");
                        signOut();
                    } else {
                        console.error(`fetchUserDetails: Failed to fetch user details: ${response.status} ${response.statusText}`);
                    }
                    return null;
                }
                const userData = await response.json();
                console.log("fetchUserDetails: Successfully fetched user data:", userData);
                return {
                    displayName: userData.full_name || userData.email.split('@')[0] || "User",
                    email: userData.email,
                    app_token: token
                };
            } catch (error) {
                console.error("fetchUserDetails: Error fetching user details:", error);
                return null;
            }
        }

        async function checkAuthOnLoad() {
            const token = localStorage.getItem('app_token');
            if (token) {
                console.log("Found app_token in localStorage. Verifying with /users/me...");
                const userDetails = await fetchUserDetails(token);
                if (userDetails) {
                    isAuthenticated = true;
                    currentUser = userDetails;
                    localStorage.setItem('user_displayName', currentUser.displayName);
                    localStorage.setItem('user_email', currentUser.email);
                    console.log("User authenticated from localStorage token via /users/me:", currentUser);
                } else {
                    console.log("Token verification via /users/me failed or no user details returned. User remains signed out.");
                }
            } else {
                isAuthenticated = false;
                currentUser = null;
                console.log("No token in localStorage. User not authenticated.");
            }
            updateAuthUI();
        }

        async function handleAuthCallback() {
            if (window.location.hash && window.location.hash.startsWith('#token=')) {
                const token = window.location.hash.substring('#token='.length);
                localStorage.setItem('app_token', token);
                console.log("Token received from URL callback. Fetching user details...");

                const userDetails = await fetchUserDetails(token);
                if (userDetails) {
                    isAuthenticated = true;
                    currentUser = userDetails;
                    localStorage.setItem('user_displayName', currentUser.displayName);
                    localStorage.setItem('user_email', currentUser.email);
                    console.log("User successfully authenticated via callback:", currentUser);
                    updateAuthUI();
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                    showTab('purchaseOrders');
                } else {
                    console.error("Could not set up user after auth callback (fetchUserDetails returned null).");
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                }
            } else if (window.location.hash && window.location.hash.startsWith('#auth_error=')){
                const errorMsg = window.location.hash.substring('#auth_error='.length);
                alert(`Google Sign-In Error: ${decodeURIComponent(errorMsg)}`);
                history.pushState("", document.title, window.location.pathname + window.location.search);
            }
        }

        function showTab(tabName) {
            const protectedTabs = ['processingSection', 'purchaseOrdersSection'];
            const sectionId = tabName.endsWith('Section') ? tabName : tabName + 'Section';

            if (protectedTabs.includes(sectionId) && !isAuthenticated) {
                alert('Please sign in to access this feature.');
                return;
            }

            document.querySelectorAll('main > section').forEach(section => section.style.display = 'none');
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement) sectionElement.style.display = 'block';

            if (sectionId === 'purchaseOrdersSection') {
                fetchGeneratedPOs();
            } else if (sectionId === 'processingSection') {
                if (!dropboxAccessToken && isAuthenticated) {
                    promptForDropboxToken();
                } else if (!isAuthenticated) {
                    signInWithGoogle();
                }
            }
            updateActiveTabButton(tabName);

            if (typeof event !== 'undefined' && event && event.target && event.target.closest('#mobileMenu')) {
                const mobileMenu = document.getElementById('mobileMenu');
                 if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                    toggleMobileMenu();
                }
            }
        }

        function updateActiveStepIndicator(activeStepName) {
            const indicators = {
                'token': document.getElementById('tokenStepIndicator').querySelector('div'),
                'configure': document.getElementById('configureStepIndicator').querySelector('div'),
                'process': document.getElementById('processDocsStepIndicator').querySelector('div')
            };
            const activeClass = 'bg-cyan-600 text-white';
            const inactiveClass = 'bg-slate-300 text-slate-500';
            const completedClass = 'bg-green-500 text-white';

            for (const step in indicators) {
                indicators[step].className = `w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center font-bold text-lg mb-2 sm:mb-3 transition-all duration-300 ${inactiveClass}`;
                if (step === 'token') indicators[step].innerHTML = '1';
                if (step === 'configure') indicators[step].innerHTML = '2';
                if (step === 'process') indicators[step].innerHTML = '3';
            }

            if (activeStepName === 'token') {
                indicators.token.className = indicators.token.className.replace(inactiveClass, activeClass);
            } else if (activeStepName === 'configure') {
                indicators.token.className = indicators.token.className.replace(inactiveClass, completedClass);
                indicators.token.innerHTML = '✓';
                indicators.configure.className = indicators.configure.className.replace(inactiveClass, activeClass);
            } else if (activeStepName === 'process') {
                indicators.token.className = indicators.token.className.replace(inactiveClass, completedClass);
                indicators.token.innerHTML = '✓';
                indicators.configure.className = indicators.configure.className.replace(inactiveClass, completedClass);
                indicators.configure.innerHTML = '✓';
                indicators.process.className = indicators.process.className.replace(inactiveClass, activeClass);
            }
        }

        function promptForDropboxToken() {
            if (!isAuthenticated) {
                alert("Please sign in first to create a new PO batch.");
                return;
            }
            document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
            document.getElementById('processingSection').style.display = 'block';
            document.getElementById('step0_token_input').classList.remove('hidden');
            document.getElementById('step1_configure_job').classList.add('hidden');
            document.getElementById('step2_processing_docs').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('expanded');
            document.getElementById('inputJobNumber').value = '';
            document.getElementById('inputProjectName').value = '';
            updateJobContextDisplay_Processing("N/A", "N/A");
            updateActiveStepIndicator('token');
            updateActiveTabButton('processingSection');
        }

        function submitDropboxToken() {
            const token = document.getElementById('dropboxAccessTokenInput').value.trim();
            if (!token) {
                alert("Please enter your Dropbox Access Token.");
                return;
            }
            dropboxAccessToken = token;
            console.log("Dropbox Token Submitted:", dropboxAccessToken ? "Token Present" : "Token Missing/Empty"); // Log if token is present

            document.getElementById('step0_token_input').classList.add('hidden');
            document.getElementById('step1_configure_job').classList.remove('hidden');
            updateActiveStepIndicator('configure');
        }

        function updateActiveTabButton(activeTabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            let targetButtonText = "";
            const sectionId = activeTabName.endsWith('Section') ? activeTabName : activeTabName + 'Section';

            if (sectionId === 'heroSection') targetButtonText = null;
            else if (sectionId === 'featuresSection') targetButtonText = 'Features';
            else if (sectionId === 'pricingSection') targetButtonText = 'Pricing';
            else if (sectionId === 'purchaseOrdersSection' || sectionId === 'processingSection') {
                targetButtonText = document.getElementById('processingNavButton').textContent.trim();
            }

            if (targetButtonText) {
                document.querySelectorAll('#desktopMenu .tab-button, #mobileMenu .tab-button').forEach(btn => {
                    if (btn.textContent.trim() === targetButtonText) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuButton = document.getElementById('mobileMenuButton');
            const menuIcon = menuButton ? menuButton.querySelector('span') : null;
            if (mobileMenu) mobileMenu.classList.toggle('hidden');
            if (menuIcon) {
                menuIcon.textContent = mobileMenu.classList.contains('hidden') ? 'menu' : 'close';
            }
        }
        const mobileMenuBtn = document.getElementById('mobileMenuButton');
        if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMobileMenu);

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuButton = document.getElementById('mobileMenuButton');
            const menuIcon = menuButton ? menuButton.querySelector('span') : null;
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
                if (menuIcon) menuIcon.textContent = 'menu';
            }
        }

        function updateJobContextDisplay_Dashboard(jobNum, projName) {
            const dispJobNum = document.getElementById('displayJobNumber_dashboard');
            const dispProjName = document.getElementById('displayProjectName_dashboard');
            if(dispJobNum) dispJobNum.textContent = jobNum || "N/A";
            if(dispProjName) dispProjName.textContent = projName || "N/A";
        }

        function updateJobContextDisplay_Processing(jobNum, projName) {
            const dispJobNum = document.getElementById('displayJobNumber_processing');
            const dispProjName = document.getElementById('displayProjectName_processing');
            if(dispJobNum) dispJobNum.textContent = jobNum || "N/A";
            if(dispProjName) dispProjName.textContent = projName || "N/A";
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded: Starting auth checks.");
            await handleAuthCallback();
            await checkAuthOnLoad();
            showTab('hero');
            console.log("DOMContentLoaded: Initial auth checks complete. isAuthenticated:", isAuthenticated);
        });

        function confirmPathsAndProceed() {
            currentJobNumberContext = document.getElementById('inputJobNumber').value.trim();
            currentProjectNameContext = document.getElementById('inputProjectName').value.trim();

            const sourcePath = document.getElementById('dropboxSourcePath').value.trim();
            const outputPath = document.getElementById('dropboxOutputPath').value.trim();

            if (!currentJobNumberContext || !currentProjectNameContext || !sourcePath || !outputPath) {
                alert("Job Number, Project Name, Dropbox Source Path, and Output Path are required."); return;
            }
            if (!dropboxAccessToken) {
                alert("Dropbox Access Token is missing. Please go back and provide it.");
                promptForDropboxToken();
                return;
            }
            updateJobContextDisplay_Processing(currentJobNumberContext, currentProjectNameContext);

            document.getElementById('step1_configure_job').classList.add('hidden');
            document.getElementById('step2_processing_docs').classList.remove('hidden');
            const progressSect = document.getElementById('progressSection'); if(progressSect) progressSect.classList.add('expanded');
            updateActiveStepIndicator('process');
            startDocumentProcessing(sourcePath, outputPath);
        }

        async function startDocumentProcessing(sourcePath, outputPath) {
            updateProgressUI(0, "Initializing job submission...");
            const stageSpinner = document.getElementById('stageSpinner'); if (stageSpinner) stageSpinner.style.display = 'block';

            const appToken = localStorage.getItem('app_token');
            if (!isAuthenticated || !appToken) {
                alert("Authentication error. Please sign in again.");
                signOut();
                if(stageSpinner) stageSpinner.style.display = 'none';
                return;
            }

            const payload = {
                dropbox_access_token: dropboxAccessToken,
                dropbox_source_path: sourcePath,
                dropbox_output_path: outputPath,
                job_number_context: currentJobNumberContext,
                project_name_context: currentProjectNameContext,
            };
            try {
                const response = await fetch(`${API_BASE_URL}/trigger-dropbox-processing`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${appToken}`
                    },
                    body: JSON.stringify(payload)
                });
                if (response.status === 401) {
                    console.warn("Celery task submission failed (401). Signing out.");
                    signOut();
                    alert("Your session has expired. Please sign in again.");
                    if(stageSpinner) stageSpinner.style.display = 'none';
                    return;
                }
                if (!response.ok) {
                    let errorDetail = `Failed to trigger processing: ${response.statusText} (Status: ${response.status})`;
                    try{ const errorData = await response.json(); errorDetail = errorData.detail || errorDetail; } catch(e){}
                    throw new Error(errorDetail);
                }
                const data = await response.json(); currentOpenPOTaskId = data.task_id;
                updateProgressUI(5, "Job submitted. Waiting for Celery worker...");
                pollTaskStatus(currentOpenPOTaskId);
            } catch (error) { console.error('Error starting processing:', error); updateProgressUI(0, `Error: ${error.message}`, true); if(stageSpinner) stageSpinner.style.display = 'none'; }
        }

        function pollTaskStatus(taskId) {
            if (statusPollInterval) clearInterval(statusPollInterval);
            const stageSpinner = document.getElementById('stageSpinner');
            statusPollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/task-status/${taskId}`);
                    if (!response.ok) {
                        let errorDetail = `Error fetching status: ${response.statusText} (Status: ${response.status})`;
                        try{ const errorData = await response.json(); errorDetail = errorData.detail || errorDetail; } catch(e){}
                        console.error(`Error fetching task status ${taskId}:`, errorDetail);
                        updateProgressUI(null, errorDetail, true);
                        clearInterval(statusPollInterval); if(stageSpinner) stageSpinner.style.display = 'none'; return;
                    }
                    const data = await response.json();
                    let currentStepMessage = data.current_step || data.status;
                    if (data.status === 'PROGRESS' && data.result && data.result.vendor_name) { currentStepMessage = `${data.current_step}: ${data.result.vendor_name}`; }
                    else if (data.status === 'PROGRESS' && data.result && data.result.current_step) { currentStepMessage = data.result.current_step; }
                    updateProgressUI(data.progress_percent, currentStepMessage);
                    if (data.status === 'SUCCESS') { clearInterval(statusPollInterval); updateProgressUI(100, "Processing complete! POs generated."); if(stageSpinner) stageSpinner.style.display = 'none'; showTab('purchaseOrders'); }
                    else if (data.status === 'FAILURE') { clearInterval(statusPollInterval); const failureDetails = typeof data.result === 'string' ? data.result : JSON.stringify(data.result); updateProgressUI(null, `Processing failed: ${failureDetails}`, true); if(stageSpinner) stageSpinner.style.display = 'none'; }
                } catch (error) { console.error('Error polling task status:', error); updateProgressUI(null, "Error polling status. Check console.", true); clearInterval(statusPollInterval); if(stageSpinner) stageSpinner.style.display = 'none'; }
            }, 3000);
        }

        function updateProgressUI(percentage, statusText, isError = false) {
            const progressFill = document.getElementById('progressFill'); const progressPercent = document.getElementById('progressPercent');
            const stageTitle = document.getElementById('stageTitle'); const stageDescription = document.getElementById('stageDescription');
            if (percentage !== null && progressFill && progressPercent) { progressFill.style.width = percentage + '%'; progressPercent.textContent = percentage + '%'; }
            if(stageTitle) stageTitle.textContent = isError ? "Error" : "Status";
            if(stageDescription) stageDescription.textContent = statusText;
            if (isError && stageTitle) { stageTitle.classList.add('text-red-600'); stageTitle.classList.remove('text-cyan-700');}
            else if (stageTitle) { stageTitle.classList.remove('text-red-600'); stageTitle.classList.add('text-cyan-700');}
        }

        function cancelProcessing() { if (statusPollInterval) clearInterval(statusPollInterval); console.log("Processing cancellation requested."); updateProgressUI(0, "Processing cancelled by user.", true); if(document.getElementById('stageSpinner')) document.getElementById('stageSpinner').style.display = 'none'; }

        async function fetchGeneratedPOs() {
            const poGrid = document.getElementById('poGrid');
            const noPOsActionContainer = document.getElementById('noPOsActionContainer');
            const noPOsMessageEl = document.getElementById('noPOsMessage');

            const appToken = localStorage.getItem('app_token');
            if (!isAuthenticated || !appToken) {
                if (poGrid) poGrid.innerHTML = '';
                if (noPOsMessageEl) noPOsMessageEl.textContent = 'Please sign in to view your Purchase Orders.';
                if (noPOsActionContainer) noPOsActionContainer.classList.remove('hidden');
                updateJobContextDisplay_Dashboard("N/A", "N/A");
                return;
            }
            if (!dropboxAccessToken) {
                console.warn("fetchGeneratedPOs: Dropbox Access Token not set for this session. User needs to connect to Dropbox first.");
                if (poGrid) poGrid.innerHTML = '';
                if (noPOsMessageEl) noPOsMessageEl.textContent = 'Please connect to Dropbox to view POs for this job.';
                if (noPOsActionContainer) noPOsActionContainer.classList.remove('hidden');
                updateJobContextDisplay_Dashboard(currentJobNumberContext || "N/A", currentProjectNameContext || "N/A");
                return;
            }

            updateJobContextDisplay_Dashboard(currentJobNumberContext, currentProjectNameContext);

            if (!poGrid) { console.error("CRITICAL UI Error: poGrid element not found!"); return; }

            poGrid.innerHTML = '<p class="text-slate-500 col-span-full text-center">Loading POs from Dropbox...</p>';
            if (noPOsActionContainer) noPOsActionContainer.classList.add('hidden');

            if (!currentJobNumberContext) {
                poGrid.innerHTML = '';
                if (noPOsMessageEl) noPOsMessageEl.textContent = 'No active job selected. Please create a new PO batch.';
                if (noPOsActionContainer) noPOsActionContainer.classList.remove('hidden');
                const poCountEl = document.getElementById('poCount'); if(poCountEl) poCountEl.textContent = `0 POs Generated`;
                allFetchedPOs = [];
                return;
            }

            try {
                const url = `${API_BASE_URL}/processed-pos/${currentJobNumberContext}?projectName=${encodeURIComponent(currentProjectNameContext)}&dropboxAccessToken=${encodeURIComponent(dropboxAccessToken)}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${appToken}` }
                });

                if (response.status === 401) {
                    console.warn("Fetching POs failed (401). Signing out.");
                    signOut();
                    alert("Your session has expired. Please sign in again.");
                    return;
                }
                if (response.status === 400) {
                    const errorData = await response.json();
                    alert(`Error fetching POs: ${errorData.detail || "Bad request (possibly missing Dropbox token for API)."}`);
                    console.error("Error fetching POs (400):", errorData);
                    if (poGrid) poGrid.innerHTML = '';
                    if (noPOsMessageEl) noPOsMessageEl.textContent = `Error: ${errorData.detail || "Could not fetch POs."}`;
                    if (noPOsActionContainer) noPOsActionContainer.classList.remove('hidden');
                    return;
                }
                if (!response.ok) {
                    let errorDetail = `Failed to fetch POs: ${response.statusText} (Status: ${response.status})`;
                    try{ const errorData = await response.json(); errorDetail = errorData.detail || errorDetail; } catch(e){}
                    throw new Error(errorDetail);
                }
                const data = await response.json(); allFetchedPOs = data.generated_pos || [];
                const poCountEl = document.getElementById('poCount'); if(poCountEl) poCountEl.textContent = `${allFetchedPOs.length} POs Generated`;

                if (allFetchedPOs.length === 0) {
                    poGrid.innerHTML = '';
                    if (noPOsMessageEl) noPOsMessageEl.textContent = `No Purchase Orders found in Dropbox for Job: ${currentJobNumberContext}. Create a new batch or select another job.`;
                    if (noPOsActionContainer) noPOsActionContainer.classList.remove('hidden');
                } else {
                    if (noPOsActionContainer) noPOsActionContainer.classList.add('hidden');
                    renderPOGrid(allFetchedPOs);
                }
            } catch (error) {
                console.error('Error fetching/rendering POs:', error);
                poGrid.innerHTML = '';
                if (noPOsMessageEl) noPOsMessageEl.textContent = `Error loading POs: ${error.message}. Try creating a new batch.`;
                if (noPOsActionContainer) noPOsActionContainer.classList.remove('hidden');
            }
        }
        function renderPOGrid(posToRender) {
            const poGrid = document.getElementById('poGrid');
            const noPOsActionContainer = document.getElementById('noPOsActionContainer');
            if (!poGrid) { console.error("renderPOGrid: poGrid element not found!"); return; }
            poGrid.innerHTML = '';
            if (!posToRender || posToRender.length === 0) { return; }
            if (noPOsActionContainer) noPOsActionContainer.classList.add('hidden');
            posToRender.forEach(po => { const card = createPOCard(po); poGrid.appendChild(card); });
        }
        function createPOCard(po) {
            const card = document.createElement('div'); card.id = `po-${po.po_id_on_grid}`;
            const isApproved = po.status && po.status.toLowerCase().includes('approved');
            card.className = `pdf-preview rounded-xl overflow-hidden ${isApproved ? 'approved' : ''} bg-white`;
            let statusDisplay = po.status || 'Unknown';
            let statusColorClass = 'bg-yellow-100 text-yellow-800';
            if (isApproved) { statusColorClass = 'bg-green-100 text-green-800'; }
            else if (po.status && po.status.toLowerCase().includes('error')) { statusColorClass = 'bg-red-100 text-red-800';}
            card.innerHTML = `<img src="assets/POWizard.png" alt="PO Preview" class="w-full h-32 object-contain p-2 bg-white"> <div class="p-4 md:p-6"><div class="flex flex-col h-full"><div class="flex justify-between items-start mb-3"><h4 class="text-md md:text-lg font-semibold text-cyan-700">${po.po_number}</h4><span class="px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1 ${statusColorClass}">${isApproved ? '<span class="material-icons-outlined text-sm">check</span>' : ''}<span>${statusDisplay}</span></span></div><p class="text-sm text-slate-700 mb-1 truncate" title="${po.vendor_name}">${po.vendor_name}</p><p class="text-lg md:text-xl font-bold text-cyan-700 mb-1">${po.total_amount.startsWith('$') ? po.total_amount : '$'+po.total_amount}</p><p class="text-xs md:text-sm text-slate-500 mb-3">Date: ${po.po_date}</p><div class="mt-auto flex space-x-2"><button onclick="openReviewModal('${po.po_id_on_grid}')" class="w-full bg-cyan-50 hover:bg-cyan-100 text-cyan-700 py-2 px-3 rounded-lg font-medium text-sm transition-colors">Review / Edit</button></div></div></div>`;
            return card;
        }
        async function openReviewModal(poIdOnGrid) {
            const appToken = localStorage.getItem('app_token');
            if (!isAuthenticated || !appToken) {
                alert("Authentication error. Please sign in again.");
                signOut(); return;
            }
            if (!dropboxAccessToken) {
                alert("Dropbox session token is missing. Please go through the 'Connect to Dropbox' step again for the current job.");
                promptForDropboxToken();
                return;
            }
            console.log("Opening review for PO ID on Grid:", poIdOnGrid);
            const poDataToReview = allFetchedPOs.find(p => p.po_id_on_grid === poIdOnGrid);

            if (poDataToReview && poDataToReview.full_po_data_for_review) {
                currentEditingPODataForModal = poDataToReview.full_po_data_for_review;
                console.log("Using pre-fetched full_po_data_for_review for modal.");
            } else {
                 try {
                    console.log(`Fetching full data for PO: Job ${currentJobNumberContext}, PO ${poIdOnGrid} using Dropbox token.`);
                    const url = `${API_BASE_URL}/get-po-data-for-review/${currentJobNumberContext}/${poIdOnGrid}?dropboxAccessToken=${encodeURIComponent(dropboxAccessToken)}`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${appToken}` }
                    });
                    if (response.status === 401) { signOut(); alert("Session expired. Please sign in."); return; }
                    if (response.status === 400) {
                        const errorData = await response.json();
                        alert(`Error fetching PO details: ${errorData.detail || "Bad request."}`); return;
                    }
                    if (!response.ok) {
                        const errorDetail = await response.json();
                        alert(`Error fetching PO details: ${errorDetail.detail || response.statusText}`); return;
                    }
                    currentEditingPODataForModal = await response.json();
                    console.log("Fetched full_po_data_for_review for modal:", currentEditingPODataForModal);
                    const indexInAllPOs = allFetchedPOs.findIndex(p => p.po_id_on_grid === poIdOnGrid);
                    if (indexInAllPOs !== -1) {
                        allFetchedPOs[indexInAllPOs].full_po_data_for_review = currentEditingPODataForModal;
                    }

                } catch (error) {
                    alert(`Error fetching PO details: ${error.message}`);
                    console.error("Fetch error for PO details:", error); return;
                }
            }
            if (!currentEditingPODataForModal) { alert('Could not load data for this PO.'); return; }

            document.getElementById('reviewModalTitle').textContent = `Review Purchase Order: ${currentEditingPODataForModal.po_number}`;
            document.getElementById('editPoIdOnGrid').value = poIdOnGrid;
            document.getElementById('editOriginalPoPackageFilename').value = currentEditingPODataForModal.original_po_package_filename || '';
            document.getElementById('editPoNumber').value = currentEditingPODataForModal.po_number;
            document.getElementById('editVendor').value = currentEditingPODataForModal.vendor_name;
            document.getElementById('editVendorAddress').value = currentEditingPODataForModal.vendor_address || '';
            document.getElementById('editVendorTIN').value = currentEditingPODataForModal.vendor_tin || '';
            document.getElementById('editPoDate').value = currentEditingPODataForModal.po_date;
            document.getElementById('editHasW9').value = String(currentEditingPODataForModal.has_w9_document || false);
            document.getElementById('editIsIncorp').value = currentEditingPODataForModal.is_incorp_on_w9 || 'Unknown';
            document.getElementById('editInvoiceRef').value = currentEditingPODataForModal.invoice_reference_from_po || '';
            document.getElementById('editTotalAmount').value = (currentEditingPODataForModal.total_vendor_amount_str || "").replace('$', '');
            document.getElementById('editAdditionalNotes').value = currentEditingPODataForModal.additional_notes || '';
            document.getElementById('editJobNumber').value = currentEditingPODataForModal.job_number;
            document.getElementById('editProjectName').value = currentEditingPODataForModal.project_name;
            document.getElementById('editBackupDocsPaths').value = JSON.stringify(currentEditingPODataForModal.backup_document_original_dropbox_paths || []);

            const lineItemsContainer = document.getElementById('editLineItemsContainer');
            lineItemsContainer.innerHTML = '';
            if (currentEditingPODataForModal.aggregated_line_items && currentEditingPODataForModal.aggregated_line_items.length > 0) {
                currentEditingPODataForModal.aggregated_line_items.forEach((item, index) => { addLineItemField(item); });
            } else {
                addLineItemField();
            }
            showReviewContent('pdf', currentEditingPODataForModal);
            document.getElementById('reviewModal').classList.remove('hidden');
            document.getElementById('reviewModal').classList.add('flex');
        }

        async function showReviewContent(contentType, poDataForDisplay) {
            const pdfDisplayArea = document.getElementById('pdfDisplayArea');
            const relevantDocsDisplayArea = document.getElementById('relevantDocsDisplayArea'); // Renamed
            const pdfViewerIframe = document.getElementById('pdfViewer');
            const pdfViewerFallbackMessage = document.getElementById('pdfViewerFallbackMessage');
            const viewPoPdfButton = document.getElementById('viewPoPdfButton');
            const viewRelevantDocsButton = document.getElementById('viewRelevantDocsButton'); // Renamed ID

            if (!poDataForDisplay) {
                console.error("showReviewContent called without poDataForDisplay.");
                if (pdfViewerIframe) pdfViewerIframe.src = 'about:blank';
                if (relevantDocsDisplayArea) relevantDocsDisplayArea.innerHTML = '<p class="text-center text-red-500">Error: PO data not available.</p>';
                return;
            }
            
            pdfViewerFallbackMessage.classList.add('hidden'); // Hide fallback by default

            if (contentType === 'pdf') {
                pdfDisplayArea.classList.remove('hidden');
                relevantDocsDisplayArea.classList.add('hidden');
                viewPoPdfButton.classList.add('btn-primary');
                viewPoPdfButton.classList.remove('bg-slate-200', 'hover:bg-slate-300', 'text-slate-700');
                viewRelevantDocsButton.classList.remove('btn-primary');
                viewRelevantDocsButton.classList.add('bg-slate-200', 'hover:bg-slate-300', 'text-slate-700');

                let pdfSrc = 'about:blank';
                if (poDataForDisplay.generated_draft_po_pdf_path_dropbox) {
                    let dbxLink = poDataForDisplay.generated_draft_po_pdf_path_dropbox;
                    console.log("Raw PO PDF link from backend:", dbxLink);

                    if (typeof dbxLink === 'string' && dbxLink.startsWith("https://")) {
                        // Check if it's a Dropbox share link that needs ?raw=1
                        if ((dbxLink.includes("dropbox.com/s/") || dbxLink.includes("dropbox.com/scl/fi/")) &&
                            !dbxLink.includes("raw=1") && !dbxLink.includes("dl=1")) {
                            
                            const urlParts = dbxLink.split('?');
                            pdfSrc = urlParts[0] + "?raw=1";
                            if (urlParts.length > 1) {
                                const otherParams = urlParts[1].split('&').filter(p => !p.startsWith('dl=') && !p.startsWith('rlkey=')); // rlkey can also interfere
                                if(otherParams.length > 0) pdfSrc += "&" + otherParams.join('&');
                            }
                            console.log("Converted PO PDF shared link to raw:", pdfSrc);
                        } else {
                            pdfSrc = dbxLink; // Assume it's a temporary direct link or already raw
                             console.log("Using PO PDF link as is (temp or already raw):", pdfSrc);
                        }
                    } else if (typeof dbxLink === 'string' && dbxLink.startsWith("/")) {
                        console.warn("Direct Dropbox path for main PO PDF, cannot embed directly:", dbxLink);
                        alert("Cannot directly preview this PDF. The backend provided a direct path instead of a viewable link for the main PO.");
                        pdfViewerFallbackMessage.classList.remove('hidden');
                        pdfSrc = 'about:blank';
                    } else {
                        console.warn("Unknown or invalid Dropbox link format for main PO PDF:", dbxLink);
                        alert("The link for the PO PDF is invalid or missing.");
                        pdfViewerFallbackMessage.classList.remove('hidden');
                        pdfSrc = 'about:blank';
                    }
                } else {
                    console.warn("No Dropbox PDF path available for main PO.");
                    alert("No PDF link available for this PO.");
                    pdfViewerFallbackMessage.classList.remove('hidden');
                }
                pdfViewerIframe.src = pdfSrc;

            } else if (contentType === 'relevantDocs') { // Renamed from 'backups'
                pdfDisplayArea.classList.add('hidden');
                relevantDocsDisplayArea.classList.remove('hidden');
                viewRelevantDocsButton.classList.add('btn-primary');
                viewRelevantDocsButton.classList.remove('bg-slate-200', 'hover:bg-slate-300', 'text-slate-700');
                viewPoPdfButton.classList.remove('btn-primary');
                viewPoPdfButton.classList.add('bg-slate-200', 'hover:bg-slate-300', 'text-slate-700');
                relevantDocsDisplayArea.innerHTML = '<p class="text-center text-slate-500">Loading relevant documents...</p>';

                const relevantDocPaths = poDataForDisplay.backup_document_original_dropbox_paths || [];
                if (relevantDocPaths.length > 0) {
                    let contentHtml = '';
                    for (const path of relevantDocPaths) {
                        let viewableLink = path;
                        let isEmbeddable = false;
                        const fileDetails = Path(path); 
                        const ext = fileDetails.suffix.toLowerCase();

                        if (typeof viewableLink === 'string' && viewableLink.startsWith("https://")) {
                            isEmbeddable = true;
                            if ((viewableLink.includes("dropbox.com/s/") || viewableLink.includes("dropbox.com/scl/fi/")) &&
                                !viewableLink.includes("raw=1") && !viewableLink.includes("dl=1")) {
                                const urlParts = viewableLink.split('?');
                                viewableLink = urlParts[0] + "?raw=1";
                                if (urlParts.length > 1) {
                                     const otherParams = urlParts[1].split('&').filter(p => !p.startsWith('dl=')&& !p.startsWith('rlkey='));
                                     if(otherParams.length > 0) viewableLink += "&" + otherParams.join('&');
                                }
                                console.log("Converted relevant doc shared link to raw:", viewableLink);
                            } else {
                                console.log("Using relevant doc link as is (temp or already raw):", viewableLink);
                            }
                        } else if (typeof viewableLink === 'string' && viewableLink.startsWith("/")) {
                            isEmbeddable = false; // Cannot embed direct paths
                            console.warn("Direct Dropbox path for relevant document:", viewableLink);
                        } else {
                             isEmbeddable = false;
                             console.warn("Unknown relevant document link format:", viewableLink);
                        }
                        
                        contentHtml += `<div class="doc-item">`;
                        contentHtml += `<p class="font-medium text-sm truncate" title="${fileDetails.name}">${fileDetails.name}</p>`;

                        if (isEmbeddable) {
                            if (['.jpg', '.jpeg', '.png', '.gif'].includes(ext)) {
                                contentHtml += `<img src="${viewableLink}" alt="${fileDetails.name}">`;
                            } else if (ext === '.pdf') {
                                contentHtml += `<div class="iframe-container my-2"><iframe src="${viewableLink}" title="${fileDetails.name}"></iframe></div>`;
                                contentHtml += `<p class="text-xs text-slate-500 text-center">If PDF doesn't display, it may have started downloading.</p>`;
                            } else {
                                contentHtml += `<a href="${viewableLink}" target="_blank" class="text-xs text-cyan-600 hover:underline block mt-1">View/Download File (Unknown Type)</a>`;
                            }
                        } else {
                            contentHtml += `<p class="text-xs text-red-500">Preview not available.</p>`;
                            if (typeof path === 'string' && path.startsWith("/")) { // Only offer Dropbox link if it's an actual path
                                contentHtml += `<a href="https://www.dropbox.com/home${path}" target="_blank" class="text-xs text-cyan-600 hover:underline block mt-1">Open in Dropbox (requires login)</a>`;
                            } else {
                                contentHtml += `<a href="${path}" target="_blank" class="text-xs text-cyan-600 hover:underline block mt-1">Download File</a>`;
                            }
                        }
                        contentHtml += `</div>`;
                    }
                    relevantDocsDisplayArea.innerHTML = contentHtml || '<p class="text-center text-slate-500">No viewable relevant documents found or links could not be generated.</p>';
                } else {
                    relevantDocsDisplayArea.innerHTML = '<p class="text-center text-slate-500">No relevant documents associated with this PO.</p>';
                }
            }
        }
        const Path = (filepathOrUrl) => {
            let nameToParse = filepathOrUrl;
            if (typeof filepathOrUrl !== 'string') {
                filepathOrUrl = String(filepathOrUrl || '');
            }

            if (filepathOrUrl.startsWith('http://') || filepathOrUrl.startsWith('https://')) {
                try {
                    const url = new URL(filepathOrUrl);
                    const pathnameParts = url.pathname.split('/');
                    nameToParse = pathnameParts[pathnameParts.length - 1];
                } catch (e) { 
                    const parts = filepathOrUrl.split(/[\\/]/);
                    nameToParse = parts[parts.length - 1];
                }
            } else { 
                 const parts = filepathOrUrl.split(/[\\/]/);
                 nameToParse = parts[parts.length - 1];
            }

            nameToParse = nameToParse || 'unknown_file';
            const name = decodeURIComponent(nameToParse); 
            const dotIndex = name.lastIndexOf('.');
            const stem = dotIndex > -1 ? name.substring(0, dotIndex) : name;
            const suffix = dotIndex > -1 ? name.substring(dotIndex).toLowerCase() : ''; 
            return { name, stem, suffix };
        };
        function addLineItemField(item = { description: '', budget_code: '', quantity: '1', unit_price: '', amount: '' }) {
            const container = document.getElementById('editLineItemsContainer'); const index = container.children.length;
            const div = document.createElement('div'); div.className = 'grid grid-cols-10 gap-2 items-center';
            div.innerHTML = `<input type="text" name="line_items[${index}][description]" value="${item.description || ''}" placeholder="Description" class="col-span-4 form-input text-sm p-1 focus:ring-cyan-500 focus:border-cyan-500"><input type="text" name="line_items[${index}][budget_code]" value="${item.budget_code || ''}" placeholder="Budget Code" class="col-span-2 form-input text-sm p-1 focus:ring-cyan-500 focus:border-cyan-500"><input type="text" name="line_items[${index}][quantity]" value="${item.quantity || '1'}" placeholder="Qty" class="col-span-1 form-input text-sm p-1 focus:ring-cyan-500 focus:border-cyan-500"><input type="text" name="line_items[${index}][unit_price]" value="${item.unit_price || ''}" placeholder="Unit Price" class="col-span-1 form-input text-sm p-1 line-item-calc focus:ring-cyan-500 focus:border-cyan-500"><input type="text" name="line_items[${index}][amount]" value="${item.amount || ''}" placeholder="Amount" class="col-span-1 form-input text-sm p-1 line-item-calc focus:ring-cyan-500 focus:border-cyan-500"><button type="button" onclick="removeLineItem(this)" class="col-span-1 text-red-500 hover:text-red-700 text-sm p-1">Remove</button>`;
            container.appendChild(div); div.querySelectorAll('.line-item-calc').forEach(input => { input.addEventListener('input', updateTotalAmountFromLines); });
            updateTotalAmountFromLines();
        }
        function removeLineItem(button) { button.parentElement.remove(); updateTotalAmountFromLines(); }
        function updateTotalAmountFromLines() {
            let total = 0;
            document.querySelectorAll('#editLineItemsContainer > div').forEach(lineDiv => {
                const amountInput = lineDiv.querySelector('input[name*="[amount]"]');
                const val = parseFloat((amountInput.value || "").replace('$', ''));
                if (!isNaN(val)) { total += val; }
            });
            document.getElementById('editTotalAmount').value = total.toFixed(2);
        }
        function closeReviewModal() {
            currentEditingPODataForModal = null; 
            document.getElementById('reviewModal').classList.add('hidden');
            document.getElementById('reviewModal').classList.remove('flex');
            const pdfViewer = document.getElementById('pdfViewer');
            if (pdfViewer) pdfViewer.src = 'about:blank';
            const relevantDocsArea = document.getElementById('relevantDocsDisplayArea');
            if(relevantDocsArea) relevantDocsArea.innerHTML = '';
            const pdfFallbackMsg = document.getElementById('pdfViewerFallbackMessage');
            if(pdfFallbackMsg) pdfFallbackMsg.classList.add('hidden');
        }
        async function submitPOChanges(isApproval) {
            const appToken = localStorage.getItem('app_token');
            if (!isAuthenticated || !appToken) {
                alert("Authentication error. Please sign in again.");
                signOut(); return;
            }
             if (!dropboxAccessToken) {
                alert("Dropbox session token is missing for regeneration. Please go through the 'Connect to Dropbox' step again for the current job.");
                promptForDropboxToken();
                return;
            }
            const form = document.getElementById('reviewForm'); const formData = new FormData(form); const poDataForRegen = {};
            formData.forEach((value, key) => { if (key.startsWith('line_items[')) { const match = key.match(/line_items\[(\d+)\]\[(\w+)\]/); if (match) { const index = parseInt(match[1]); const field = match[2]; if (!poDataForRegen.aggregated_line_items) { poDataForRegen.aggregated_line_items = []; } while (poDataForRegen.aggregated_line_items.length <= index) { poDataForRegen.aggregated_line_items.push({}); } if (field === 'amount' || field === 'unit_price') { poDataForRegen.aggregated_line_items[index][field] = String(value).replace('$', ''); } else { poDataForRegen.aggregated_line_items[index][field] = value; } } } else { if (key === 'has_w9_document') { poDataForRegen[key] = value === 'true'; } else { poDataForRegen[key] = value; } } });
            poDataForRegen.original_po_package_filename = document.getElementById('editOriginalPoPackageFilename').value;
            poDataForRegen.job_number = document.getElementById('editJobNumber').value;
            poDataForRegen.project_name = document.getElementById('editProjectName').value;
            
            // For regeneration, backend should re-fetch the _Data.json for persistent backup paths.
            // So, what we send here for 'backup_document_original_dropbox_paths' is less critical for re-download,
            // but we should still send what the form has. The backend handles getting the correct persistent paths.
            try {
                poDataForRegen.backup_document_original_dropbox_paths = JSON.parse(document.getElementById('editBackupDocsPaths').value || "[]");
            } catch (e) {
                poDataForRegen.backup_document_original_dropbox_paths = []; 
                console.error("Error parsing backup_document_original_dropbox_paths for regeneration submission:", e);
            }

            if (poDataForRegen.aggregated_line_items) { poDataForRegen.aggregated_line_items = poDataForRegen.aggregated_line_items.filter(item => item.description || item.amount ); }
            if (isApproval) {
                alert("PO Approval functionality is planned for a future update. For now, saving changes.");
            }
            console.log("Submitting PO Data for Regeneration:", poDataForRegen);
            try {
                const url = `${API_BASE_URL}/regenerate-po?dropboxAccessToken=${encodeURIComponent(dropboxAccessToken)}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${appToken}`
                    },
                    body: JSON.stringify({ po_data_to_regenerate: poDataForRegen })
                });
                if (response.status === 401) { signOut(); alert("Session expired. Please sign in."); return; }
                if (response.status === 400) {
                    const errorData = await response.json();
                    alert(`Error regenerating PO: ${errorData.detail || "Bad request."}`); return;
                }
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || `Failed to regenerate PO: ${response.statusText}`); }
                alert('PO successfully ' + (isApproval ? 'approved (simulated) and' : '') + ' regenerated and updated!');
                closeReviewModal();
                fetchGeneratedPOs();
            } catch (error) { console.error('Error submitting PO changes:', error); alert(`Error: ${error.message}`); }
        }
        document.getElementById('filterStatus').addEventListener('change', applyFiltersAndSort);
        document.getElementById('filterVendorName').addEventListener('input', applyFiltersAndSort);
        document.getElementById('sortPOs').addEventListener('change', applyFiltersAndSort);
        function applyFiltersAndSort() {
            let filteredPOs = [...allFetchedPOs];
            const statusFilter = document.getElementById('filterStatus').value;
            const vendorNameFilter = document.getElementById('filterVendorName').value.toLowerCase();
            const sortBy = document.getElementById('sortPOs').value;
            if (statusFilter !== 'all') {
                filteredPOs = filteredPOs.filter(po => po.status && po.status.toLowerCase().includes(statusFilter));
            }
            if (vendorNameFilter) {
                filteredPOs = filteredPOs.filter(po => po.vendor_name && po.vendor_name.toLowerCase().includes(vendorNameFilter));
            }
            switch (sortBy) {
                case 'date':
                    filteredPOs.sort((a, b) => new Date(a.po_date) - new Date(b.po_date));
                    break;
                case 'vendor':
                    filteredPOs.sort((a, b) => (a.vendor_name || "").localeCompare(b.vendor_name || ""));
                    break;
                case 'amount':
                    filteredPOs.sort((a, b) => parseFloat((a.total_amount || "0").replace('$', '').replace(',', '')) - parseFloat((b.total_amount || "0").replace('$', '').replace(',', '')));
                    break;
                case 'status':
                    filteredPOs.sort((a, b) => (a.status || "").localeCompare(b.status || ""));
                    break;
            }
            renderPOGrid(filteredPOs);
        }
    </script>
</body>
</html>