<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <!-- Updated Font Imports -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <title>PO Wizard - Film Production Invoice Processing</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        /* Updated Color Scheme & Styles */
        body {
            background-color: #f5f3ff; /* Lighter Lavender/Off-white: bg-violet-50 is similar, using a direct hex for precision */
            font-family: 'Inter', 'Noto Sans', sans-serif;
        }
        .po-wizard-title-font {
            font-family: 'Poppins', sans-serif;
        }
        .hero-gradient {
            background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 50%, #ddd6fe 100%); /* Lighter purple gradient - Tailwind: from-purple-400 via-purple-300 to-purple-200 */
        }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07); }

        .progress-section { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.5s ease-in-out; }
        .progress-section.expanded { max-height: 800px; opacity: 1; margin-top: 2rem; }

        .pdf-preview { background: #ffffff; border: 1px solid #e2e8f0; /* Tailwind: border-slate-200 */ transition: all 0.3s ease; }
        .pdf-preview:hover { border-color: #a78bfa; /* Tailwind: border-purple-400 */ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .pdf-preview.approved { border-color: #34d399; /* Tailwind: border-green-400 */ background: #f0fdf4; /* Tailwind: bg-green-50 */ }

        .tab-button.active { background: #8b5cf6; /* Tailwind: bg-purple-600 */ color: white; }
        
        .btn-primary {
            background-color: #8b5cf6; /* Tailwind: bg-purple-600 */
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #7c3aed; /* Tailwind: bg-purple-700 */
        }
        .btn-accent { /* Accent color like the pricing page's popular plan */
            background-color: #f59e0b; /* Tailwind: bg-amber-500 */
            color: #ffffff; /* White text often works well, or a dark purple like #4c1d95 */
            transition: background-color 0.3s ease;
        }
        .btn-accent:hover {
            background-color: #d97706; /* Tailwind: bg-amber-600 */
        }

        /* Other existing styles from previous version */
        .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .connector-line { width: 4rem; height: 2px; background: #e2e8f0; } /* border-slate-200 */
        .connector-line.completed { background: #34d399; } /* bg-green-400 */
        
        .pricing-card { transition: all 0.3s ease; background-color: white; }
        .pricing-card.popular { 
            transform: scale(1.05); 
            border: 2px solid #f59e0b; /* Tailwind: border-amber-500 */
            box-shadow: 0 20px 25px -5px rgba(245,158,11, 0.15); 
        }
        .pricing-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07); 
        }
        .pricing-card.popular:hover { transform: translateY(-4px) scale(1.05); }
        
        .floating-benefit { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        
        .iframe-container { position: relative; overflow: hidden; width: 100%; padding-top: 141.42%; /* Aspect Ratio for A4-like PDF */ }
        .iframe-container iframe { position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; border: none; }

        /* Ensure form inputs have focus styles consistent with the theme */
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #a78bfa; /* Tailwind: border-purple-400 */
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.3); /* Tailwind: ring-purple-400 ring-opacity-30 */
        }
    </style>
</head>
<body class="bg-[#f5f3ff] font-['Inter','Noto_Sans',sans-serif]"> {/* Equivalent to custom body bg */}
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
            <div class="w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-3 h-16 md:h-20"> {/* Adjusted height slightly for better balance */}
                    <!-- Logo and Brand Name -->
                    <a href="#" onclick="showTab('hero'); if(typeof closeMobileMenu === 'function') closeMobileMenu();" class="flex items-center cursor-pointer">
                        <!-- Replace with your actual logo path or use an SVG -->
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0idXJsKCNwYWludDBfbGluZWFyXzExMF8xMTUpIi8+CjxwYXRoIGQ9Ik0xMCAxMG EyIDIgMCAwMC0yIDJ2MTRhMiAyIDAgMDAyIDJoMTZlMiAyIDAgMDAyLTJWMTJhMiAyIDAgMDAtMi0ySDEwem0yIDNoMTJ2MkgxMlYxM3ptMCA1aDEydjJIMTJWMThtMCA1aDEydjJIMTJWMjMiIGZpbGw9IndoaXRlIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9InBhaW50MF9saW5lYXJfMTEwXzExNSIgeDE9IjAiIHkxPSIwIiB4Mj0iNDAiIHkyPSI0MCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjOGI1Y2Y2Ii8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzRiMGVhNyIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=" alt="PO Wizard Logo" class="h-8 w-auto mr-2 sm:mr-3 md:h-10">
                        <div class="flex flex-col justify-center">
                            <span class="po-wizard-title-font block text-xl sm:text-2xl font-bold text-purple-700 leading-tight">PO Wizard</span>
                            <span class="block text-xs text-slate-500 leading-tight mt-[-2px] sm:mt-0">Built for Production</span>
                        </div>
                    </a>

                    <!-- Desktop Navigation & Actions -->
                    <div id="desktopMenu" class="hidden md:flex items-center space-x-3 lg:space-x-4">
                        <nav class="flex items-center space-x-1 lg:space-x-3">
                            <button onclick="showTab('features')" class="tab-button px-3 py-2 rounded-lg text-sm lg:text-base text-slate-700 hover:text-purple-600 hover:bg-purple-50 transition-colors">Features</button>
                            <button onclick="showTab('pricing')" class="tab-button px-3 py-2 rounded-lg text-sm lg:text-base text-slate-700 hover:text-purple-600 hover:bg-purple-50 transition-colors">Pricing</button>
                            <button onclick="showTab('processing')" id="processingNavButton" class="tab-button px-3 py-2 rounded-lg text-sm lg:text-base text-slate-700 hover:text-purple-600 hover:bg-purple-50 transition-colors whitespace-nowrap">My POs / Process</button>
                        </nav>
                        <div class="flex items-center space-x-2 lg:space-x-3 border-l border-slate-300 pl-3 lg:pl-4">
                             <input type="text" id="currentJobNumber" placeholder="Job #" title="Current Job Number" class="form-input px-3 py-2 border border-slate-300 rounded-lg text-sm w-24" value="85319">
                            <button onclick="showSignIn()" id="signInButton" class="whitespace-nowrap items-center px-3 py-2 text-sm lg:text-base text-slate-700 hover:text-purple-600 transition-colors">
                                Sign In
                            </button>
                            <button onclick="showSignUp()" id="getStartedButton" class="btn-primary whitespace-nowrap px-3 lg:px-4 py-2 rounded-lg font-medium text-sm lg:text-base">
                                Get Started
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mobile Menu Button (Hamburger) -->
                    <div class="md:hidden">
                        <button id="mobileMenuButton" class="text-slate-600 hover:text-purple-700 focus:outline-none p-2">
                            <span class="material-icons-outlined text-3xl">menu</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile Menu Dropdown -->
            <div id="mobileMenu" class="md:hidden hidden bg-white border-t border-slate-200 shadow-lg absolute w-full z-40">
                <nav class="flex flex-col space-y-1 p-4">
                    <button onclick="showTab('features'); toggleMobileMenu();" class="tab-button block px-3 py-3 rounded-lg text-slate-700 hover:text-purple-700 hover:bg-purple-50 text-left text-base transition-colors">Features</button>
                    <button onclick="showTab('pricing'); toggleMobileMenu();" class="tab-button block px-3 py-3 rounded-lg text-slate-700 hover:text-purple-700 hover:bg-purple-50 text-left text-base transition-colors">Pricing</button>
                    <button onclick="showTab('processing'); toggleMobileMenu();" id="mobileProcessingNavButton" class="tab-button block px-3 py-3 rounded-lg text-slate-700 hover:text-purple-700 hover:bg-purple-50 text-left text-base transition-colors">My POs / Process</button>
                    <hr class="my-2"/>
                    <div class="px-1 py-2">
                        <label for="mobileCurrentJobNumber" class="block text-sm font-medium text-slate-700 mb-1">Current Job #:</label>
                        <input type="text" id="mobileCurrentJobNumber" placeholder="Job #" class="form-input w-full px-3 py-2 border border-slate-300 rounded-lg text-sm" value="85319">
                    </div>
                    <button onclick="showSignIn(); toggleMobileMenu();" id="mobileSignInButton" class="block px-3 py-3 rounded-lg text-slate-700 hover:text-purple-700 hover:bg-purple-50 text-left text-base transition-colors">Sign In</button>
                    <button onclick="showSignUp(); toggleMobileMenu();" id="mobileGetStartedButton" class="block w-full text-center btn-primary px-3 py-3 rounded-lg font-medium text-base">Get Started Free</button>
                </nav>
            </div>
        </header>

        <!-- Main Content (Sections: Hero, Features, Pricing, Processing, PurchaseOrders) -->
        <!-- Sections will be shown/hidden by JS based on showTab() -->

        <!-- Hero Section -->
        <section id="heroSection" class="hero-gradient py-16 lg:py-20">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h2 class="po-wizard-title-font text-5xl lg:text-6xl font-bold text-white mb-8 leading-tight">
                        Stop Wrestling with<br/>
                        <span class="text-amber-300">Post-Production Receipts</span>
                    </h2>
                    <p class="text-xl lg:text-2xl text-purple-100 max-w-4xl mx-auto leading-relaxed mb-12">
                        Transform your chaotic pile of vendor invoices, receipts, and credit card statements into professional purchase orders in minutes, not hours. Built specifically for <strong>production coordinators</strong> tired of manual PO creation.
                    </p>
                    <div class="grid md:grid-cols-2 gap-8 md:gap-12 max-w-5xl mx-auto mb-16">
                        <div class="bg-purple-800/30 backdrop-blur-sm rounded-2xl p-6 md:p-8 border border-purple-500/30 card-hover">
                            <div class="text-red-300 mb-4"><span class="material-icons-outlined text-4xl">warning</span></div>
                            <h3 class="po-wizard-title-font text-xl font-bold text-white mb-4">The Old Way</h3>
                            <ul class="text-purple-200 space-y-2 text-left text-sm md:text-base">
                                <li>• Hours manually entering vendor data</li><li>• Hunting through receipts and invoices</li><li>• Formatting POs one by one</li><li>• Missing deadlines for production companies</li><li>• Losing track of expenses</li>
                            </ul>
                        </div>
                        <div class="bg-green-800/20 backdrop-blur-sm rounded-2xl p-6 md:p-8 border border-green-500/30 card-hover">
                            <div class="text-green-300 mb-4"><span class="material-icons-outlined text-4xl">auto_awesome</span></div>
                            <h3 class="po-wizard-title-font text-xl font-bold text-white mb-4">The PO Wizard Way</h3>
                            <ul class="text-purple-200 space-y-2 text-left text-sm md:text-base">
                                <li>• AI scans all your documents automatically</li><li>• Extracts vendor info, amounts, dates</li><li>• Generates professional POs instantly</li><li>• Ready for production company submission</li><li>• Complete audit trail maintained</li>
                            </ul>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-6">
                        <button onclick="showSignUp()" class="btn-accent text-white font-bold py-3 px-6 sm:py-4 sm:px-8 rounded-xl text-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-amber-300/50">
                            Start Free Trial
                        </button>
                        <button onclick="showTab('features')" class="bg-white/10 backdrop-blur-sm hover:bg-white/20 text-white font-semibold py-3 px-6 sm:py-4 sm:px-8 rounded-xl border border-white/20 transition-all duration-200">
                            See How It Works
                        </button>
                    </div>
                    <p class="text-purple-300 mt-6 text-sm">No credit card required • 2-minute setup • Works with any production size</p>
                </div>
                <div class="text-center">
                    <p class="text-purple-300 text-sm mb-6">Trusted by Production Coordinators at:</p>
                    <div class="flex flex-wrap justify-center items-center gap-x-8 sm:gap-x-12 gap-y-4 opacity-80">
                        <div class="text-white font-semibold text-md sm:text-lg">Netflix</div><div class="text-white font-semibold text-md sm:text-lg">HBO</div><div class="text-white font-semibold text-md sm:text-lg">Warner Bros</div><div class="text-white font-semibold text-md sm:text-lg">A24</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section id="featuresSection" class="py-16 lg:py-20 bg-violet-100 hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h3 class="po-wizard-title-font text-3xl md:text-4xl font-bold text-purple-800 mb-6">How PO Wizard Works</h3>
                    <p class="text-lg md:text-xl text-slate-700 max-w-3xl mx-auto">Three simple steps to transform your post-production chaos into organized, professional purchase orders.</p>
                </div>
                <div class="grid lg:grid-cols-3 gap-8 md:gap-12 mb-20">
                    <!-- Feature Item 1 -->
                    <div class="text-center p-6 bg-white rounded-xl shadow-lg card-hover">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-purple-200 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-2xl md:text-3xl font-bold text-purple-700">1</span></div>
                        <h4 class="po-wizard-title-font text-xl font-semibold text-purple-900 mb-3">Upload Your Mess</h4>
                        <p class="text-slate-600 mb-6 text-sm md:text-base">Connect your Dropbox or upload folders full of vendor invoices, receipts, credit card statements, and random charges.</p>
                        <div class="bg-purple-50 rounded-xl p-4">
                            <div class="flex justify-center space-x-3 mb-2">
                                <div class="w-10 h-14 md:w-12 md:h-16 bg-red-100 rounded border-2 border-red-200 flex items-center justify-center"><span class="material-icons-outlined text-red-600 text-lg md:text-sm">receipt</span></div>
                                <div class="w-10 h-14 md:w-12 md:h-16 bg-blue-100 rounded border-2 border-blue-200 flex items-center justify-center"><span class="material-icons-outlined text-blue-600 text-lg md:text-sm">description</span></div>
                                <div class="w-10 h-14 md:w-12 md:h-16 bg-green-100 rounded border-2 border-green-200 flex items-center justify-center"><span class="material-icons-outlined text-green-600 text-lg md:text-sm">credit_card</span></div>
                            </div><p class="text-xs text-slate-500">Invoices, receipts, statements</p>
                        </div>
                    </div>
                    <!-- Feature Item 2 -->
                    <div class="text-center p-6 bg-white rounded-xl shadow-lg card-hover">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-amber-200 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-2xl md:text-3xl font-bold text-amber-700">2</span></div>
                        <h4 class="po-wizard-title-font text-xl font-semibold text-purple-900 mb-3">AI Works Its Magic</h4>
                        <p class="text-slate-600 mb-6 text-sm md:text-base">Our AI scans every document, extracts vendor information, amounts, dates, and categories. No manual data entry.</p>
                        <div class="bg-purple-50 rounded-xl p-4">
                            <div class="flex justify-center mb-3"><div class="w-14 h-14 md:w-16 md:h-16 bg-gradient-to-br from-purple-600 to-amber-500 rounded-full flex items-center justify-center"><span class="material-icons-outlined text-white text-xl md:text-2xl">psychology</span></div></div>
                            <div class="space-y-1 md:space-y-2"><div class="h-2 bg-gradient-to-r from-purple-300 to-amber-300 rounded animate-pulse"></div><div class="h-2 bg-gradient-to-r from-amber-300 to-purple-300 rounded animate-pulse" style="animation-delay: 0.5s"></div><div class="h-2 bg-gradient-to-r from-purple-300 to-amber-300 rounded animate-pulse" style="animation-delay: 1s"></div></div>
                        </div>
                    </div>
                    <!-- Feature Item 3 -->
                    <div class="text-center p-6 bg-white rounded-xl shadow-lg card-hover">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-green-200 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-2xl md:text-3xl font-bold text-green-700">3</span></div>
                        <h4 class="po-wizard-title-font text-xl font-semibold text-purple-900 mb-3">Perfect POs Delivered</h4>
                        <p class="text-slate-600 mb-6 text-sm md:text-base">Get professionally formatted purchase orders ready for production company submission. Review, approve, and download.</p>
                        <div class="bg-purple-50 rounded-xl p-4">
                            <div class="grid grid-cols-2 gap-2">
                                <div class="h-16 md:h-20 bg-white rounded-lg border-2 border-green-300 p-2"><div class="h-1.5 md:h-2 bg-green-300 rounded mb-1"></div><div class="h-1.5 md:h-2 bg-green-100 rounded mb-1"></div><div class="h-1.5 md:h-2 bg-green-100 rounded"></div><div class="text-xs text-green-700 mt-1 md:mt-2 font-medium">PO-001</div></div>
                                <div class="h-16 md:h-20 bg-white rounded-lg border-2 border-green-300 p-2"><div class="h-1.5 md:h-2 bg-green-300 rounded mb-1"></div><div class="h-1.5 md:h-2 bg-green-100 rounded mb-1"></div><div class="h-1.5 md:h-2 bg-green-100 rounded"></div><div class="text-xs text-green-700 mt-1 md:mt-2 font-medium">PO-002</div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Benefits Grid -->
                <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8">
                    <div class="text-center floating-benefit p-4"><div class="w-12 h-12 md:w-16 md:h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-blue-600 text-xl md:text-2xl">schedule</span></div><h4 class="font-bold text-purple-900 mb-1 text-md md:text-lg">Save 10+ Hours</h4><p class="text-slate-600 text-sm">Per production wrap</p></div>
                    <div class="text-center floating-benefit p-4" style="animation-delay: 1s"><div class="w-12 h-12 md:w-16 md:h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-green-600 text-xl md:text-2xl">check_circle</span></div><h4 class="font-bold text-purple-900 mb-1 text-md md:text-lg">99% Accuracy</h4><p class="text-slate-600 text-sm">AI-powered extraction</p></div>
                    <div class="text-center floating-benefit p-4" style="animation-delay: 2s"><div class="w-12 h-12 md:w-16 md:h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-purple-600 text-xl md:text-2xl">trending_up</span></div><h4 class="font-bold text-purple-900 mb-1 text-md md:text-lg">Faster Payments</h4><p class="text-slate-600 text-sm">Professional formatting</p></div>
                    <div class="text-center floating-benefit p-4" style="animation-delay: 3s"><div class="w-12 h-12 md:w-16 md:h-16 bg-amber-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-amber-600 text-xl md:text-2xl">security</span></div><h4 class="font-bold text-purple-900 mb-1 text-md md:text-lg">Audit Trail</h4><p class="text-slate-600 text-sm">Complete documentation</p></div>
                </div>
            </div>
        </section>
        
        <!-- Pricing Section -->
        <section id="pricingSection" class="py-16 lg:py-20 bg-violet-100 hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h3 class="po-wizard-title-font text-3xl md:text-4xl font-bold text-purple-800 mb-6">Simple, Transparent Pricing</h3>
                    <p class="text-lg md:text-xl text-slate-700 max-w-3xl mx-auto">Choose the plan that fits your production workflow. Start free, upgrade as you grow.</p>
                </div>
                <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                    <!-- Free Tier -->
                    <div class="pricing-card bg-white rounded-2xl p-6 md:p-8 shadow-lg border border-purple-200">
                        <div class="text-center mb-8"><h4 class="po-wizard-title-font text-xl md:text-2xl font-bold text-purple-900 mb-2">Free</h4><p class="text-slate-600 mb-6">Perfect for small productions</p><div class="text-3xl md:text-4xl font-bold text-purple-900 mb-2">Free</div><p class="text-slate-500 text-sm">No credit card required</p></div>
                        <ul class="space-y-3 md:space-y-4 mb-8 text-sm md:text-base">
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Up to 5 vendors per production</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Single production processing</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Basic AI scanning</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Standard PO templates</span></li>
                        </ul><button onclick="showSignUp('free')" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-3 px-6 rounded-xl transition-colors text-sm md:text-base">Get Started Free</button>
                    </div>
                    <!-- Pro Tier (Popular) -->
                    <div class="pricing-card popular bg-white rounded-2xl p-6 md:p-8 shadow-xl relative border-2 border-amber-500">
                        <div class="absolute -top-3.5 left-1/2 transform -translate-x-1/2"><span class="bg-amber-500 text-white px-3 py-1 rounded-full text-xs md:text-sm font-medium">Most Popular</span></div>
                        <div class="text-center mb-8"><h4 class="po-wizard-title-font text-xl md:text-2xl font-bold text-purple-900 mb-2">Pro</h4><p class="text-slate-600 mb-6">For growing productions</p><div class="text-3xl md:text-4xl font-bold text-purple-900 mb-2">$20</div><p class="text-slate-500 text-sm">per month</p></div>
                        <ul class="space-y-3 md:space-y-4 mb-8 text-sm md:text-base">
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited vendors</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited production amounts</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited iterations on 1 production</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Advanced AI with 99% accuracy</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Custom PO templates</span></li>
                        </ul><button onclick="showSignUp('pro')" class="w-full btn-accent font-semibold py-3 px-6 rounded-xl text-sm md:text-base">Start Free Trial</button>
                    </div>
                    <!-- Enterprise Tier -->
                    <div class="pricing-card bg-white rounded-2xl p-6 md:p-8 shadow-lg border border-purple-200">
                        <div class="text-center mb-8"><h4 class="po-wizard-title-font text-xl md:text-2xl font-bold text-purple-900 mb-2">Enterprise</h4><p class="text-slate-600 mb-6">For production companies</p><div class="text-3xl md:text-4xl font-bold text-purple-900 mb-2">$30</div><p class="text-slate-500 text-sm">per month</p></div>
                        <ul class="space-y-3 md:space-y-4 mb-8 text-sm md:text-base">
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited productions</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited vendors</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Cross-tracking between productions</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Microsoft Excel integration</span></li>
                            <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Fully custom, unbranded designs</span></li>
                        </ul><button onclick="showSignUp('enterprise')" class="w-full btn-primary font-semibold py-3 px-6 rounded-xl text-sm md:text-base">Contact Sales</button>
                    </div>
                </div>
                 <div class="text-center mt-12">
                    <p class="text-slate-600 mb-4 text-sm md:text-base">All plans include 14-day free trial • No setup fees • Cancel anytime</p>
                    <div class="flex flex-wrap justify-center items-center gap-x-4 md:gap-x-6 gap-y-2 text-xs md:text-sm text-slate-500">
                        <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">security</span>Bank-grade security</span>
                        <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">support</span>24/7 support</span>
                        <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">cloud_upload</span>99.9% uptime</span>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Processing Section -->
        <section id="processingSection" class="bg-gradient-to-br from-purple-100 via-violet-50 to-orange-50 py-12 md:py-16 lg:py-20 hidden">
             <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <div class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-6 md:p-8 lg:p-12 max-w-4xl mx-auto">
                    <div id="jobContextDisplay" class="mb-6 text-purple-800">Job: <span id="displayJobNumber" class="font-semibold">N/A</span> | Project: <span id="displayProjectName" class="font-semibold">N/A</span></div>
                    <div class="flex justify-center items-center space-x-4 md:space-x-8 mb-10 md:mb-12">
                         <div id="step1Indicator" class="flex flex-col items-center"><div class="w-10 h-10 md:w-12 md:h-12 bg-slate-300 rounded-full flex items-center justify-center text-slate-500 font-bold text-lg mb-2 transition-all duration-300">1</div><span class="text-xs md:text-sm font-medium text-slate-500">Configure Job</span></div>
                        <div id="step2Indicator" class="flex flex-col items-center"><div class="w-10 h-10 md:w-12 md:h-12 bg-slate-300 rounded-full flex items-center justify-center text-slate-500 font-bold text-lg mb-2 transition-all duration-300">2</div><span class="text-xs md:text-sm font-medium text-slate-500">Process Docs</span></div>
                    </div>
                    <div id="step1" class="step-content">
                        <div class="text-center mb-8"><div class="w-16 h-16 md:w-20 md:h-20 bg-purple-200 rounded-3xl flex items-center justify-center mx-auto mb-6"><svg class="w-8 h-8 md:w-10 md:h-10 text-purple-700" fill="currentColor" viewBox="0 0 24 24"><path d="M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.015-3.569-1.156-.503.325-.808.817-.808 1.331 0 .694.521 1.304 1.25 1.304.188 0 .375-.047.551-.132l.812.812c-.387.226-.808.363-1.25.363-1.279 0-2.344-1.117-2.344-2.5 0-.691.279-1.328.775-1.791.871-.814 2.079-1.076 3.146-.805l1.397-1.397c.094-.094.219-.156.344-.156.281 0 .531.219.531.5 0 .125-.062.25-.156.344l-8.687 8.687c-.094.094-.219.156-.344-.156-.281 0-.531-.219-.531-.5 0-.125.062.25-.156.344l3.344-3.344z"/></svg></div>
                            <h3 class="po-wizard-title-font text-xl md:text-2xl font-bold text-purple-900 mb-4">Configure Dropbox Processing</h3>
                            <p class="text-slate-600 max-w-lg mx-auto mb-8 text-sm md:text-base">Enter Dropbox paths for source documents and PO output. Set Job Number in header.</p>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div><label for="dropboxSourcePath" class="block text-sm font-medium text-slate-700 text-left mb-1">Dropbox Source Path (Vendor Folders):</label><input type="text" id="dropboxSourcePath" value="/POWizardCompany/Hyundai_Commercial/SourceVendorDocs" class="form-input w-full px-3 py-2 border border-slate-300 rounded-lg"></div>
                            <div><label for="dropboxOutputPath" class="block text-sm font-medium text-slate-700 text-left mb-1">Dropbox Output Path (Generated POs):</label><input type="text" id="dropboxOutputPath" value="/POWizardCompany/Hyundai_Commercial/GeneratedPOs" class="form-input w-full px-3 py-2 border border-slate-300 rounded-lg"></div>
                        </div>
                        <button onclick="confirmPathsAndProceed()" id="confirmPathsButton" class="w-full btn-primary font-semibold py-3 px-6 md:py-4 md:px-8 rounded-xl text-sm md:text-base">Confirm Paths & Process</button>
                        <div class="text-xs text-slate-500 text-center mt-4"><span class="material-icons-outlined text-green-600 text-sm mr-1 align-middle">lock</span>Secure connection via backend.</div>
                    </div>
                    <div id="step2" class="step-content hidden">
                         <div class="text-center mb-8"><div class="w-16 h-16 md:w-20 md:h-20 bg-green-100 rounded-3xl flex items-center justify-center mx-auto mb-6"><span class="material-icons-outlined text-green-700 text-2xl md:text-3xl">auto_awesome</span></div>
                            <h3 class="po-wizard-title-font text-xl md:text-2xl font-bold text-purple-900 mb-4">Processing Documents...</h3>
                            <p class="text-slate-600 max-w-lg mx-auto mb-8 text-sm md:text-base" id="processingStatusText">AI is scanning your Dropbox folder, extracting data, and generating purchase orders...</p>
                        </div>
                        <div id="progressSection" class="progress-section"> 
                            <div class="border-t border-slate-200 pt-6 md:pt-8">
                                <div class="mb-6">
                                    <div class="w-full h-2.5 md:h-3 bg-slate-200 rounded-full overflow-hidden"><div id="progressFill" class="h-full bg-gradient-to-r from-green-500 to-purple-500 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div>
                                    <div class="flex justify-between items-center mt-2 md:mt-3"><span id="progressPercent" class="text-xs md:text-sm font-semibold text-slate-700">0%</span><span id="estimatedTime" class="text-xs text-slate-500">Calculating...</span></div>
                                </div>
                                <div class="bg-purple-50 rounded-xl p-4 md:p-6 text-center">
                                    <div class="flex items-center justify-center space-x-2 mb-2 md:mb-3"><h4 id="stageTitle" class="text-md md:text-lg font-semibold text-purple-900">Initializing...</h4><div id="stageSpinner" class="w-4 h-4 border-2 border-slate-300 border-t-purple-600 rounded-full animate-spin"></div></div>
                                    <p id="stageDescription" class="text-slate-600 text-sm">Preparing to process your documents.</p>
                                </div>
                                <button onclick="cancelProcessing()" id="cancelProcessingButton" class="mt-6 w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 md:py-3 md:px-6 rounded-xl text-sm md:text-base transition-colors duration-200">Cancel Processing (Not Implemented)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Purchase Orders Section -->
        <section id="purchaseOrdersSection" class="py-12 md:py-16 bg-white hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <div><h3 class="po-wizard-title-font text-2xl md:text-3xl font-bold text-purple-800 mb-1">Generated Purchase Orders</h3><p class="text-slate-600 text-sm md:text-base" id="currentJobDisplayPOs">Review your generated POs before submission</p></div>
                    <div class="flex items-center space-x-3"><span id="poCount" class="text-sm text-slate-600">0 POs Generated</span><button class="btn-primary px-3 py-2 rounded-lg font-medium text-sm" title="Functionality not yet implemented"><span class="flex items-center space-x-1.5"><span class="material-icons-outlined text-sm">download</span><span>Download All (Soon)</span></span></button></div>
                </div>
                <div class="bg-purple-50 rounded-xl p-4 mb-8 flex flex-col sm:flex-row flex-wrap items-center justify-between gap-3 md:gap-4">
                    <div class="flex items-center space-x-3 md:space-x-4">
                        <select id="filterStatus" class="form-select bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm"><option value="all">All Status</option><option value="pending">Pending Review</option><option value="approved">Approved</option></select>
                        <input type="text" id="filterVendorName" placeholder="Filter by Vendor..." class="form-input bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm w-40">
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-slate-600">Sort by:</span>
                        <select id="sortPOs" class="form-select bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm"><option value="date">Date Created</option><option value="vendor">Vendor Name</option><option value="amount">Amount</option><option value="status">Status</option></select>
                    </div>
                </div>
                <div id="poGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                     <p id="noPOsMessage" class="text-slate-500 col-span-full text-center hidden py-8">No purchase orders generated yet for this job, or an error occurred.</p>
                </div>
                <div id="paginationControls" class="flex justify-center items-center space-x-2 md:space-x-4 mt-12 hidden"><button class="p-2 hover:bg-purple-100 rounded-lg transition-colors"><span class="material-icons-outlined">chevron_left</span></button><div class="flex space-x-1"><button class="px-3 py-1.5 md:px-3 md:py-2 bg-purple-600 text-white rounded-lg text-sm">1</button></div><button class="p-2 hover:bg-purple-100 rounded-lg transition-colors"><span class="material-icons-outlined">chevron_right</span></button></div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-purple-900 text-purple-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center space-x-3 mb-4 md:mb-0">
                         <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0idXJsKCNwYWludDBfbGluZWFyXzExMF8xMTUpIi8+CjxwYXRoIGQ9Ik0xMCAxMG EyIDIgMCAwMC0yIDJ2MTRhMiAyIDAgMDAyIDJoMTZlMiAyIDAgMDAyLTJWMTJhMiAyIDAgMDAtMi0ySDEwem0yIDNoMTJ2MkgxMlYxM3ptMCA1aDEydjJIMTJWMThtMCA1aDEydjJIMTJWMjMiIGZpbGw9IndoaXRlIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9InBhaW50MF9saW5lYXJfMTEwXzExNSIgeDE9IjAiIHkxPSIwIiB4Mj0iNDAiIHkyPSI0MCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjOGI1Y2Y2Ii8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzRiMGVhNyIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=" alt="PO Wizard Logo" class="h-7 w-auto filter brightness-0 invert opacity-80">
                        <span class="po-wizard-title-font font-bold text-md text-white">PO Wizard</span><span class="text-purple-300 text-xs">for Film Production</span>
                    </div>
                    <div class="text-center"><p class="text-purple-300 text-xs">Streamlining post-production workflows since 2024</p></div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Review PO Modal -->
    <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-2xl p-5 md:p-8 max-w-6xl w-full mx-auto max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6"><h3 id="reviewModalTitle" class="po-wizard-title-font text-xl md:text-2xl font-bold text-purple-900">Review Purchase Order</h3><button onclick="closeReviewModal()" class="text-slate-400 hover:text-slate-600 p-1"><span class="material-icons-outlined text-2xl">close</span></button></div>
            <div class="flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-8">
                <div class="w-full lg:w-1/2 iframe-container bg-slate-100 rounded-lg"><iframe id="pdfViewer" src="about:blank" title="PO PDF" class="rounded-lg"></iframe></div>
                <div class="w-full lg:w-1/2">
                    <form id="reviewForm" class="space-y-3 md:space-y-4">
                        <input type="hidden" id="editPoIdOnGrid"><input type="hidden" id="editOriginalPoPackageFilename"><input type="hidden" id="editBackupDocsPaths" name="backup_document_original_dropbox_paths">
                        <div><label for="editPoNumber" class="block text-sm font-medium text-slate-700 mb-1">PO Number</label><input type="text" id="editPoNumber" name="po_number" class="w-full form-input text-sm md:text-base" readonly></div>
                        <div><label for="editVendor" class="block text-sm font-medium text-slate-700 mb-1">Vendor Name</label><input type="text" id="editVendor" name="vendor_name" class="w-full form-input text-sm md:text-base"></div>
                        <div><label for="editVendorAddress" class="block text-sm font-medium text-slate-700 mb-1">Vendor Address</label><textarea id="editVendorAddress" name="vendor_address" rows="2" class="w-full form-textarea text-sm md:text-base"></textarea></div>
                        <div class="grid grid-cols-2 gap-3 md:gap-4"><div><label for="editVendorTIN" class="block text-sm font-medium text-slate-700 mb-1">Vendor TIN/SSN</label><input type="text" id="editVendorTIN" name="vendor_tin" class="w-full form-input text-sm md:text-base"></div><div><label for="editPoDate" class="block text-sm font-medium text-slate-700 mb-1">PO Date (MM/DD/YY)</label><input type="text" id="editPoDate" name="po_date" class="w-full form-input text-sm md:text-base"></div></div>
                         <div class="grid grid-cols-2 gap-3 md:gap-4"><div><label for="editHasW9" class="block text-sm font-medium text-slate-700 mb-1">W9 on File?</label><select id="editHasW9" name="has_w9_document" class="w-full form-select text-sm md:text-base"><option value="true">Yes</option><option value="false">No</option></select></div><div><label for="editIsIncorp" class="block text-sm font-medium text-slate-700 mb-1">Incorporated?</label><select id="editIsIncorp" name="is_incorp_on_w9" class="w-full form-select text-sm md:text-base"><option value="Unknown">Unknown</option><option value="Yes">Yes</option><option value="No">No</option></select></div></div>
                        <div><label for="editInvoiceRef" class="block text-sm font-medium text-slate-700 mb-1">Invoice Reference(s)</label><input type="text" id="editInvoiceRef" name="invoice_reference_from_po" class="w-full form-input text-sm md:text-base"></div>
                        <h4 class="text-md font-semibold text-purple-800 pt-2">Line Items:</h4>
                        <div id="editLineItemsContainer" class="space-y-2 max-h-40 md:max-h-48 overflow-y-auto border p-2 rounded-md border-purple-200 bg-purple-50/50"></div>
                        <button type="button" onclick="addLineItemField()" class="text-sm text-purple-600 hover:text-purple-800 font-medium">+ Add Line Item</button>
                        <div><label for="editTotalAmount" class="block text-sm font-medium text-slate-700 mb-1">Total Amount ($)</label><input type="text" id="editTotalAmount" name="total_vendor_amount_str" class="w-full form-input text-sm md:text-base"></div>
                        <div><label for="editAdditionalNotes" class="block text-sm font-medium text-slate-700 mb-1">Additional Notes</label><textarea id="editAdditionalNotes" name="additional_notes" rows="2" class="w-full form-textarea text-sm md:text-base"></textarea></div>
                        <input type="hidden" id="editJobNumber" name="job_number"><input type="hidden" id="editProjectName" name="project_name">
                    </form>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 md:space-x-4 mt-6 md:mt-8"><button onclick="submitPOChanges(false)" class="flex-1 btn-primary py-2.5 px-4 md:py-3 md:px-6 rounded-xl font-medium text-sm md:text-base">Save Changes & Regenerate PO</button><button onclick="submitPOChanges(true)" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2.5 px-4 md:py-3 md:px-6 rounded-xl font-medium text-sm md:text-base">Approve PO (Future)</button><button onclick="closeReviewModal()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2.5 px-4 md:py-3 md:px-6 rounded-xl font-medium text-sm md:text-base">Cancel</button></div>
        </div>
    </div>

    <script>
        // All JavaScript remains the same as your provided "latest version"
        // ... (paste the full script from your latest index.html here) ...
        // For brevity, I'm not repeating the entire JS block if it's unchanged from your last paste.
        // Key JS to ensure is present:
        const API_BASE_URL = 'https://po-wizard-backend-private.onrender.com/api/v1'; // Ensure this matches your Render backend
        let isAuthenticated = false; 
        let currentJobNumberContext = "85319"; // Default, will be updated by input
        let currentProjectNameContext = "Macy's Holiday Shoot"; // Example, make this dynamic if needed
        let currentOpenPOTaskId = null; 
        let statusPollInterval = null;
        let allFetchedPOs = []; 

        // --- Tab Management & UI Updates ---
        function showTab(tabName) {
            document.querySelectorAll('main > section').forEach(section => section.style.display = 'none');
            const sectionElement = document.getElementById(tabName + 'Section');
            if (sectionElement) sectionElement.style.display = 'block';
            else console.warn(`Section not found for tab: ${tabName}Section`);


            if (tabName === 'processing') {
                if (!isAuthenticated) { alert('Please "Sign In" to access processing.'); showTab('hero'); return; }
                const step1 = document.getElementById('step1');
                const step2 = document.getElementById('step2');
                const progressSection = document.getElementById('progressSection');
                if(step1) step1.classList.remove('hidden');
                if(step2) step2.classList.add('hidden');
                if(progressSection) progressSection.classList.remove('expanded');
                updateJobContextDisplay();
            } else if (tabName === 'purchaseOrders') {
                 if (!isAuthenticated) { alert('Please "Sign In" to view POs.'); showTab('hero'); return; }
                fetchGeneratedPOs(); 
            }
            updateActiveTabButton(tabName);
             // Close mobile menu if an item from it was clicked
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden') && event && event.currentTarget && event.currentTarget.closest('#mobileMenu')) {
                toggleMobileMenu(false); // Pass false to explicitly close
            }
        }

        function updateActiveTabButton(activeTab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            const buttonMap = { 
                'hero': null, // No dedicated nav button for hero usually
                'features': 'Features', 
                'pricing': 'Pricing', 
                'processing': 'My POs / Process', // This button covers both processing and purchaseOrders tabs
                'purchaseOrders': 'My POs / Process' 
            };
            if (buttonMap[activeTab]) {
                document.querySelectorAll('#desktopMenu .tab-button, #mobileMenu .tab-button').forEach(btn => {
                    if (btn.textContent.trim() === buttonMap[activeTab]) {
                        btn.classList.add('active');
                    }
                });
            }
        }
        
        function toggleMobileMenu(forceState) { // forceState can be true (open), false (close), or undefined (toggle)
            const mobileMenu = document.getElementById('mobileMenu');
            const menuButton = document.getElementById('mobileMenuButton');
            const menuIcon = menuButton ? menuButton.querySelector('span') : null;

            if (!mobileMenu || !menuIcon) return;

            let isOpen;
            if (typeof forceState === 'boolean') {
                isOpen = forceState;
                if (isOpen) mobileMenu.classList.remove('hidden');
                else mobileMenu.classList.add('hidden');
            } else {
                mobileMenu.classList.toggle('hidden');
                isOpen = !mobileMenu.classList.contains('hidden');
            }
            menuIcon.textContent = isOpen ? 'close' : 'menu';
        }

        const mobileMenuBtn = document.getElementById('mobileMenuButton');
        if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => toggleMobileMenu());
        
        // Function to explicitly close mobile menu (e.g. on logo click)
        function closeMobileMenu() { 
           toggleMobileMenu(false);
        }

        const desktopJobInput = document.getElementById('currentJobNumber');
        const mobileJobInput = document.getElementById('mobileCurrentJobNumber');

        function syncJobNumberAndUpdateContext(sourceElement) {
            const newValue = sourceElement.value.trim();
            if (desktopJobInput) desktopJobInput.value = newValue;
            if (mobileJobInput) mobileJobInput.value = newValue;
            currentJobNumberContext = newValue || "NOT_SET"; // Ensure it's not empty
            updateJobContextDisplay(); 
            // If POs tab is active, refresh POs when job number changes
            if (document.getElementById('purchaseOrdersSection')?.style.display === 'block' && isAuthenticated) {
                fetchGeneratedPOs();
            }
        }
        // Use 'input' for live updates, 'change' for after blur
        if (desktopJobInput) desktopJobInput.addEventListener('input', () => syncJobNumberAndUpdateContext(desktopJobInput));
        if (mobileJobInput) mobileJobInput.addEventListener('input', () => syncJobNumberAndUpdateContext(mobileJobInput));
        
        function showSignIn() {
            isAuthenticated = true;
            ['signInButton', 'mobileSignInButton'].forEach(id => { 
                const btn = document.getElementById(id); 
                if(btn) { btn.classList.add('hidden'); } // Hide sign-in buttons
            });
            ['getStartedButton', 'mobileGetStartedButton'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) { 
                    btn.textContent = 'Process Job'; 
                    btn.onclick = () => { 
                        showTab('processing'); 
                        if(id.startsWith('mobile')) toggleMobileMenu(false); // Close mobile menu
                    };
                }
            });
            // Potentially show user name or "Sign Out" button here in future
            syncJobNumberAndUpdateContext(desktopJobInput || mobileJobInput); // Update context from current input value
            showTab('processing'); // Default to processing tab after sign in
        }
        function showSignUp() { showSignIn(); } // For now, sign up also just signs in
        
        function updateJobContextDisplay() {
            const dispJobNum = document.getElementById('displayJobNumber');
            const dispProjName = document.getElementById('displayProjectName');
            const jobDispPOs = document.getElementById('currentJobDisplayPOs');
            
            // Update currentProjectNameContext if needed (e.g., from another input or logic)
            // For now, it's hardcoded or could be tied to job number logic if desired.

            if(dispJobNum) dispJobNum.textContent = currentJobNumberContext || "N/A";
            if(dispProjName) dispProjName.textContent = currentProjectNameContext || "N/A"; 
            if (jobDispPOs) jobDispPOs.textContent = `Job: ${currentJobNumberContext || "N/A"} | Project: ${currentProjectNameContext || "N/A"}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (desktopJobInput) currentJobNumberContext = desktopJobInput.value.trim() || "85319";
            else if (mobileJobInput) currentJobNumberContext = mobileJobInput.value.trim() || "85319";
            updateJobContextDisplay();
            showTab('hero'); 
        });

        // --- API Call Functions & Processing Logic ---
        function confirmPathsAndProceed() { 
            syncJobNumberAndUpdateContext(desktopJobInput || mobileJobInput);
            const sourcePath = document.getElementById('dropboxSourcePath').value.trim();
            const outputPath = document.getElementById('dropboxOutputPath').value.trim();
            if (!currentJobNumberContext || currentJobNumberContext === "NOT_SET" || !sourcePath || !outputPath) {
                alert("Job Number (in header), Dropbox Source Path, and Output Path are required."); return;
            }
            // Update step indicators
            const step1Div = document.getElementById('step1Indicator')?.querySelector('div');
            const step1Span = document.getElementById('step1Indicator')?.querySelector('span');
            const step2Div = document.getElementById('step2Indicator')?.querySelector('div');
            const step2Span = document.getElementById('step2Indicator')?.querySelector('span');

            if(step1Div) { step1Div.className = 'w-10 h-10 md:w-12 md:h-12 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-lg mb-2 transition-all duration-300'; step1Div.innerHTML = '✓';}
            if(step1Span) step1Span.className = 'text-xs md:text-sm font-medium text-slate-700';
            if(step2Div) step2Div.className = 'w-10 h-10 md:w-12 md:h-12 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg mb-2 transition-all duration-300';
            if(step2Span) step2Span.className = 'text-xs md:text-sm font-medium text-slate-700';
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            const progressSect = document.getElementById('progressSection'); if(progressSect) progressSect.classList.add('expanded');
            startDocumentProcessing(sourcePath, outputPath);
        }
        
        async function startDocumentProcessing(sourcePath, outputPath) {
            updateProgressUI(0, "Initializing job submission...");
            const stageSpinner = document.getElementById('stageSpinner'); if (stageSpinner) stageSpinner.style.display = 'block';
            const payload = { dropbox_source_path: sourcePath, dropbox_output_path: outputPath, job_number_context: currentJobNumberContext, project_name_context: currentProjectNameContext };
            try {
                const response = await fetch(`${API_BASE_URL}/trigger-dropbox-processing`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { 
                    let errorDetail = `Failed to trigger processing: ${response.statusText} (Status: ${response.status})`;
                    try{ const errorData = await response.json(); errorDetail = errorData.detail || errorDetail; } catch(e){ console.error("Could not parse error JSON:", e); }
                    throw new Error(errorDetail);
                }
                const data = await response.json(); currentOpenPOTaskId = data.task_id;
                updateProgressUI(5, "Job submitted. Waiting for Celery worker...");
                pollTaskStatus(currentOpenPOTaskId);
            } catch (error) { console.error('Error starting processing:', error); updateProgressUI(0, `Error: ${error.message}`, true); if(stageSpinner) stageSpinner.style.display = 'none'; }
        }

        function pollTaskStatus(taskId) {
            if (statusPollInterval) clearInterval(statusPollInterval);
            const stageSpinner = document.getElementById('stageSpinner');
            statusPollInterval = setInterval(async () => {
                if (!taskId) { clearInterval(statusPollInterval); return; } // Stop if no task ID
                try {
                    const response = await fetch(`${API_BASE_URL}/task-status/${taskId}`);
                    if (!response.ok) { 
                        let errorDetail = `Error fetching status: ${response.statusText} (Status: ${response.status})`;
                        try{ const errorData = await response.json(); errorDetail = errorData.detail || errorDetail; } catch(e){ console.error("Could not parse error JSON for status:", e); }
                        console.error(`Error fetching task status ${taskId}:`, errorDetail); 
                        updateProgressUI(null, errorDetail, true); 
                        clearInterval(statusPollInterval); if(stageSpinner) stageSpinner.style.display = 'none'; return; 
                    }
                    const data = await response.json();
                    let currentStepMessage = data.current_step || data.status; // Fallback to status if current_step is not there
                    if (data.status === 'PROGRESS' && data.result && data.result.current_step) { // Prefer result.current_step if available in PROGRESS
                        currentStepMessage = data.result.current_step;
                         if(data.result.vendor_name) currentStepMessage += `: ${data.result.vendor_name}`;
                    }
                    updateProgressUI(data.progress_percent, currentStepMessage);
                    if (data.status === 'SUCCESS') { clearInterval(statusPollInterval); updateProgressUI(100, "Processing complete! POs generated."); if(stageSpinner) stageSpinner.style.display = 'none'; showTab('purchaseOrders'); } 
                    else if (data.status === 'FAILURE') { clearInterval(statusPollInterval); const failureDetails = typeof data.result === 'string' ? data.result : JSON.stringify(data.result); updateProgressUI(null, `Processing failed: ${failureDetails}`, true); if(stageSpinner) stageSpinner.style.display = 'none'; }
                } catch (error) { console.error('Error polling task status:', error); updateProgressUI(null, "Error polling status. Check console.", true); clearInterval(statusPollInterval); if(stageSpinner) stageSpinner.style.display = 'none'; }
            }, 3000); // Poll every 3 seconds
        }

        function updateProgressUI(percentage, statusText, isError = false) {
            const progressFill = document.getElementById('progressFill'); const progressPercent = document.getElementById('progressPercent');
            const stageTitle = document.getElementById('stageTitle'); const stageDescription = document.getElementById('stageDescription');
            if (percentage !== null && progressFill && progressPercent) { progressFill.style.width = percentage + '%'; progressPercent.textContent = percentage + '%'; }
            if(stageTitle) stageTitle.textContent = isError ? "Error" : "Status"; 
            if(stageDescription) stageDescription.textContent = statusText;
            if (isError && stageTitle) { stageTitle.classList.add('text-red-600'); } else if (stageTitle) { stageTitle.classList.remove('text-red-600'); }
        }
        
        function cancelProcessing() { if (statusPollInterval) clearInterval(statusPollInterval); currentOpenPOTaskId=null; console.log("Processing cancellation requested."); updateProgressUI(0, "Processing cancelled by user.", true); if(document.getElementById('stageSpinner')) document.getElementById('stageSpinner').style.display = 'none'; }

        // --- Purchase Order Grid & Modal Logic (mostly unchanged from your latest version) ---
        async function fetchGeneratedPOs() {
            updateJobContextDisplay(); 
            const poGrid = document.getElementById('poGrid'); const noPOsMessage = document.getElementById('noPOsMessage');
            const purchaseOrdersSection = document.getElementById('purchaseOrdersSection');
            if (!poGrid) { console.error("CRITICAL UI Error: poGrid element not found!"); return; }
            poGrid.innerHTML = '<p class="text-slate-500 col-span-full text-center py-8">Loading POs...</p>'; 
            if (noPOsMessage) noPOsMessage.classList.add('hidden');
            
            if (!currentJobNumberContext || currentJobNumberContext === "NOT_SET") { 
                poGrid.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">Please set a Job Number in the header to load POs.</p>'; return; 
            }
            try {
                const response = await fetch(`${API_BASE_URL}/processed-pos/${currentJobNumberContext}?projectName=${encodeURIComponent(currentProjectNameContext)}`);
                if (!response.ok) {
                    let errorDetail = `Failed to fetch POs: ${response.statusText} (Status: ${response.status})`;
                    try{ const errorData = await response.json(); errorDetail = errorData.detail || errorDetail; } catch(e){ console.error("Could not parse PO fetch error JSON:", e); }
                    throw new Error(errorDetail);
                }
                const data = await response.json(); allFetchedPOs = data.generated_pos || [];
                const poCountEl = document.getElementById('poCount'); if(poCountEl) poCountEl.textContent = `${allFetchedPOs.length} POs Generated`;
                renderPOGrid(allFetchedPOs);
            } catch (error) {
                console.error('Error fetching/rendering POs:', error);
                if (poGrid) { poGrid.innerHTML = `<p class="text-red-500 col-span-full text-center py-8">Error loading POs: ${error.message}</p>`; }
                if (noPOsMessage) { noPOsMessage.classList.remove('hidden'); noPOsMessage.textContent = `Error: ${error.message}. Check console.`; }
            }
        }

        function renderPOGrid(posToRender) {
            const poGrid = document.getElementById('poGrid'); const noPOsMessage = document.getElementById('noPOsMessage');
            if (!poGrid) { console.error("renderPOGrid: poGrid element not found!"); return; }
            poGrid.innerHTML = ''; 
            if (!posToRender || posToRender.length === 0) {
                if (noPOsMessage) { noPOsMessage.classList.remove('hidden'); noPOsMessage.textContent = 'No purchase orders found for this job/filters.'; } 
                return;
            }
            if (noPOsMessage) noPOsMessage.classList.add('hidden');
            posToRender.forEach(po => { const card = createPOCard(po); poGrid.appendChild(card); });
        }
        
        function createPOCard(po) { // Uses the new color scheme from CSS
            const card = document.createElement('div'); card.id = `po-${po.po_id_on_grid}`;
            const isApproved = po.status && po.status.toLowerCase().includes('approved');
            card.className = `pdf-preview rounded-xl overflow-hidden shadow-md ${isApproved ? 'approved' : ''}`;
            let statusDisplay = po.status || 'Unknown'; let statusColorClass = 'bg-amber-100 text-amber-800';
            if (isApproved) { statusColorClass = 'bg-green-100 text-green-800'; } else if (po.status && po.status.toLowerCase().includes('error')) { statusColorClass = 'bg-red-100 text-red-800';}
             // Using a placeholder image for PO preview thumbnail
            card.innerHTML = `<div class="h-32 bg-slate-200 flex items-center justify-center"><span class="material-icons-outlined text-4xl text-slate-400">picture_as_pdf</span></div> <div class="p-4 md:p-6"><div class="flex flex-col h-full"><div class="flex justify-between items-start mb-3"><h4 class="po-wizard-title-font text-md md:text-lg font-semibold text-purple-800">${po.po_number}</h4><span class="px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1 ${statusColorClass}">${isApproved ? '<span class="material-icons-outlined text-sm">check</span>' : ''}<span>${statusDisplay}</span></span></div><p class="text-sm text-slate-700 mb-1 truncate" title="${po.vendor_name}">${po.vendor_name}</p><p class="text-lg md:text-xl font-bold text-purple-800 mb-1">${po.total_amount.startsWith('$') ? po.total_amount : '$'+po.total_amount}</p><p class="text-xs md:text-sm text-slate-500 mb-3">Date: ${po.po_date}</p><div class="mt-auto flex space-x-2"><button onclick="openReviewModal('${po.po_id_on_grid}')" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-700 py-2 px-3 rounded-lg font-medium text-sm transition-colors">Review / Edit</button></div></div></div>`;
            return card;
        }
        // The rest of your JS: openReviewModal, addLineItemField, removeLineItem, updateTotalAmountFromLines, closeReviewModal, submitPOChanges, applyFiltersAndSort
        // (Pasted from your last working version, assuming it's largely correct and functional)
        // ... (This is where the rest of your JS functions like openReviewModal, addLineItemField, etc., would go) ...
        // ... Make sure to paste ALL your JS functions here from the previous complete version ...
         async function openReviewModal(poIdOnGrid) {
            console.log("Opening review for PO ID on Grid:", poIdOnGrid);
            let poToReview = allFetchedPOs.find(p => p.po_id_on_grid === poIdOnGrid);
            let poFullData;

            if (poToReview && poToReview.full_po_data_for_review) {
                poFullData = poToReview.full_po_data_for_review;
            } else {
                 try { 
                    console.log(`Fetching full data for PO: Job ${currentJobNumberContext}, PO ${poIdOnGrid}`); 
                    const response = await fetch(`${API_BASE_URL}/get-po-data-for-review/${currentJobNumberContext}/${poIdOnGrid}`); 
                    if (!response.ok) { 
                        const errorText = await response.text(); // Get raw text for debugging
                        console.error("Raw error response from API:", errorText);
                        let errorDetail = `Error fetching PO details: ${response.statusText} (Status: ${response.status})`;
                        try { const errorData = JSON.parse(errorText); errorDetail = errorData.detail || errorDetail; } 
                        catch (e) { console.warn("Could not parse error JSON, using status text.", e); errorDetail += ` - Server response: ${errorText.substring(0,100)}...`;}
                        alert(errorDetail); return; 
                    } 
                    poFullData = await response.json();
                } catch (error) { alert(`Network or other error fetching PO details: ${error.message}`); console.error("Fetch error for PO details:", error); return; }
            }
            
            if (!poFullData) { alert('Could not load data for this PO. The full_po_data_for_review might be missing or the fetch failed.'); return; }
            currentEditingPOData = poFullData; // Store for submission

            document.getElementById('reviewModalTitle').textContent = `Review Purchase Order: ${currentEditingPOData.po_number || poIdOnGrid}`;
            document.getElementById('editPoIdOnGrid').value = poIdOnGrid; 
            document.getElementById('editOriginalPoPackageFilename').value = currentEditingPOData.original_po_package_filename || `${poIdOnGrid}_Package.pdf`;
            document.getElementById('editPoNumber').value = currentEditingPOData.po_number || poIdOnGrid; 
            document.getElementById('editVendor').value = currentEditingPOData.vendor_name || ''; 
            document.getElementById('editVendorAddress').value = currentEditingPOData.vendor_address || ''; 
            document.getElementById('editVendorTIN').value = currentEditingPOData.vendor_tin || ''; 
            document.getElementById('editPoDate').value = currentEditingPOData.po_date || new Date().toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: '2-digit'}); 
            document.getElementById('editHasW9').value = String(currentEditingPOData.has_w9_document || false); 
            document.getElementById('editIsIncorp').value = currentEditingPOData.is_incorp_on_w9 || 'Unknown'; 
            document.getElementById('editInvoiceRef').value = currentEditingPOData.invoice_reference_from_po || ''; 
            document.getElementById('editTotalAmount').value = (currentEditingPOData.total_vendor_amount_str || "0.00").replace('$', ''); 
            document.getElementById('editAdditionalNotes').value = currentEditingPOData.additional_notes || '';
            document.getElementById('editJobNumber').value = currentEditingPOData.job_number || currentJobNumberContext; 
            document.getElementById('editProjectName').value = currentEditingPOData.project_name || currentProjectNameContext;
            document.getElementById('editBackupDocsPaths').value = JSON.stringify(currentEditingPOData.backup_document_original_dropbox_paths || []);
            
            const lineItemsContainer = document.getElementById('editLineItemsContainer'); lineItemsContainer.innerHTML = '';
            if (currentEditingPOData.aggregated_line_items && currentEditingPOData.aggregated_line_items.length > 0) { 
                currentEditingPOData.aggregated_line_items.forEach((item, index) => { addLineItemField(item); }); 
            } else { addLineItemField(); } // Add one empty if none
            
            let pdfSrc = 'about:blank';
            if (currentEditingPOData.generated_draft_po_pdf_path_dropbox) {
                let dbxLink = currentEditingPOData.generated_draft_po_pdf_path_dropbox; 
                if (dbxLink.startsWith("DROPBOX:")) dbxLink = dbxLink.substring(8);
                if (dbxLink.includes("dropbox.com") && !dbxLink.includes("raw=1")) { 
                    dbxLink = dbxLink.replace("?dl=0", "?raw=1").replace("dl=0", "raw=1"); 
                    if (!dbxLink.includes("?raw=1") && !dbxLink.endsWith("?raw=1")) dbxLink = dbxLink.includes("?") ? dbxLink + "&raw=1" : dbxLink + "?raw=1";
                } 
                pdfSrc = dbxLink;
            } else { console.warn("No Dropbox PDF path for preview."); /* alert("No PDF preview link available."); */ }
            console.log("Setting PDF viewer src to:", pdfSrc); 
            const pdfViewer = document.getElementById('pdfViewer'); if(pdfViewer) pdfViewer.src = pdfSrc;
            
            const reviewModal = document.getElementById('reviewModal'); if(reviewModal) {reviewModal.classList.remove('hidden'); reviewModal.classList.add('flex');}
        }
        
        function addLineItemField(item = { description: '', budget_code: '', quantity: '1', unit_price: '', amount: '' }) {
            const container = document.getElementById('editLineItemsContainer'); if(!container) return;
            const index = container.children.length;
            const div = document.createElement('div'); div.className = 'grid grid-cols-10 gap-2 items-center';
            div.innerHTML = `<input type="text" name="line_items[${index}][description]" value="${item.description || ''}" placeholder="Description" class="col-span-4 form-input text-sm p-1 focus:ring-purple-500 focus:border-purple-500"><input type="text" name="line_items[${index}][budget_code]" value="${item.budget_code || ''}" placeholder="Budget Code" class="col-span-2 form-input text-sm p-1 focus:ring-purple-500 focus:border-purple-500"><input type="text" name="line_items[${index}][quantity]" value="${item.quantity || '1'}" placeholder="Qty" class="col-span-1 form-input text-sm p-1 focus:ring-purple-500 focus:border-purple-500"><input type="text" name="line_items[${index}][unit_price]" value="${item.unit_price || ''}" placeholder="Unit Price" class="col-span-1 form-input text-sm p-1 line-item-calc focus:ring-purple-500 focus:border-purple-500"><input type="text" name="line_items[${index}][amount]" value="${item.amount || ''}" placeholder="Amount" class="col-span-1 form-input text-sm p-1 line-item-calc focus:ring-purple-500 focus:border-purple-500"><button type="button" onclick="removeLineItem(this)" class="col-span-1 text-red-500 hover:text-red-700 text-sm p-1">Remove</button>`;
            container.appendChild(div); div.querySelectorAll('.line-item-calc').forEach(input => { input.addEventListener('input', updateTotalAmountFromLines); });
        }

        function removeLineItem(button) { if(button && button.parentElement) button.parentElement.remove(); updateTotalAmountFromLines(); }
        
        function updateTotalAmountFromLines() {
            let total = 0; document.querySelectorAll('#editLineItemsContainer > div').forEach(lineDiv => { const amountInput = lineDiv.querySelector('input[name*="[amount]"]'); if(amountInput) {const val = parseFloat(amountInput.value.replace('$', '')); if (!isNaN(val)) { total += val; } }}); const totalAmountInput = document.getElementById('editTotalAmount'); if(totalAmountInput) totalAmountInput.value = total.toFixed(2);
        }

        function closeReviewModal() { const modal = document.getElementById('reviewModal'); if(modal) {modal.classList.add('hidden'); modal.classList.remove('flex');} const pdfViewer = document.getElementById('pdfViewer'); if(pdfViewer) pdfViewer.src = 'about:blank'; currentEditingPOData = null; }

        async function submitPOChanges(isApproval) {
            const form = document.getElementById('reviewForm'); if(!form) return;
            const formData = new FormData(form); const poDataForRegen = {};
            formData.forEach((value, key) => { if (key.startsWith('line_items[')) { const match = key.match(/line_items\[(\d+)\]\[(\w+)\]/); if (match) { const index = parseInt(match[1]); const field = match[2]; if (!poDataForRegen.aggregated_line_items) { poDataForRegen.aggregated_line_items = []; } while (poDataForRegen.aggregated_line_items.length <= index) { poDataForRegen.aggregated_line_items.push({}); } if (field === 'amount' || field === 'unit_price') { poDataForRegen.aggregated_line_items[index][field] = String(value).replace('$', ''); } else { poDataForRegen.aggregated_line_items[index][field] = value; } } } else { if (key === 'has_w9_document') { poDataForRegen[key] = value === 'true'; } else { poDataForRegen[key] = value; } } });
            poDataForRegen.original_po_package_filename = document.getElementById('editOriginalPoPackageFilename')?.value; 
            poDataForRegen.job_number = document.getElementById('editJobNumber')?.value; 
            poDataForRegen.project_name = document.getElementById('editProjectName')?.value;
            try { poDataForRegen.backup_document_original_dropbox_paths = JSON.parse(document.getElementById('editBackupDocsPaths')?.value || "[]"); } catch (e) { poDataForRegen.backup_document_original_dropbox_paths = []; console.error("Error parsing backup_document_original_dropbox_paths:", e); }
            if (poDataForRegen.aggregated_line_items) { poDataForRegen.aggregated_line_items = poDataForRegen.aggregated_line_items.filter(item => item.description || item.amount ); }
            if (isApproval) { alert("PO Approval functionality is planned for a future update."); /* For now, treat approval same as save & regen */ }
            console.log("Submitting PO Data for Regeneration:", poDataForRegen);
            try {
                const response = await fetch(`${API_BASE_URL}/regenerate-po`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ po_data_to_regenerate: poDataForRegen }) });
                if (!response.ok) { 
                    const errorText = await response.text();
                    console.error("Raw error response from regenerate-po API:", errorText);
                    let errorDetail = `Failed to regenerate PO: ${response.statusText} (Status: ${response.status})`;
                    try { const errorData = JSON.parse(errorText); errorDetail = errorData.detail || errorDetail; } 
                    catch (e) { console.warn("Could not parse error JSON for regenerate-po, using status text.",e); errorDetail += ` - Server response: ${errorText.substring(0,100)}...`; }
                    throw new Error(errorDetail); 
                }
                const updatedPOInfo = await response.json(); alert('PO successfully regenerated and updated!'); closeReviewModal(); fetchGeneratedPOs(); 
            } catch (error) { console.error('Error submitting PO changes:', error); alert(`Error: ${error.message}`); }
        }
        
        const filterStatusEl = document.getElementById('filterStatus');
        const filterVendorNameEl = document.getElementById('filterVendorName');
        const sortPOsEl = document.getElementById('sortPOs');

        if(filterStatusEl) filterStatusEl.addEventListener('change', applyFiltersAndSort);
        if(filterVendorNameEl) filterVendorNameEl.addEventListener('input', applyFiltersAndSort);
        if(sortPOsEl) sortPOsEl.addEventListener('change', applyFiltersAndSort);

        function applyFiltersAndSort() {
            if (!allFetchedPOs) return;
            let filteredPOs = [...allFetchedPOs]; 
            const statusFilter = filterStatusEl ? filterStatusEl.value : 'all'; 
            const vendorNameFilter = filterVendorNameEl ? filterVendorNameEl.value.toLowerCase() : ''; 
            const sortBy = sortPOsEl ? sortPOsEl.value : 'date';
            
            if (statusFilter !== 'all') { filteredPOs = filteredPOs.filter(po => po.status && po.status.toLowerCase().includes(statusFilter));}
            if (vendorNameFilter) { filteredPOs = filteredPOs.filter(po => po.vendor_name && po.vendor_name.toLowerCase().includes(vendorNameFilter));}
            
            const parsePODate = (dateStr) => { // Handles MM/DD/YY or MM/DD/YYYY
                if (!dateStr) return new Date(0); // Early date for undefined
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const year = parseInt(parts[2]);
                    // If year is two digits, assume 20xx
                    return new Date(year < 100 ? 2000 + year : year, parseInt(parts[0]) - 1, parseInt(parts[1]));
                }
                return new Date(dateStr); // Fallback to direct parsing
            };

            switch (sortBy) { 
                case 'date': filteredPOs.sort((a, b) => parsePODate(a.po_date) - parsePODate(b.po_date)); break; 
                case 'vendor': filteredPOs.sort((a, b) => (a.vendor_name || "").localeCompare(b.vendor_name || "")); break; 
                case 'amount': filteredPOs.sort((a, b) => parseFloat((a.total_amount || "0").replace('$', '').replace(',', '')) - parseFloat((b.total_amount || "0").replace('$', '').replace(',', ''))); break; 
                case 'status': filteredPOs.sort((a, b) => (a.status || "").localeCompare(b.status || "")); break; 
            }
            renderPOGrid(filteredPOs);
        }
    </script>
</body>
</html>