<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;600;700" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <title>PO Wizard - Film Production Invoice Processing</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        .hero-gradient { background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 50%, #4a5568 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.1); }
        .progress-section { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.5s ease-in-out; }
        .progress-section.expanded { max-height: 800px; opacity: 1; margin-top: 2rem; }
        .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .pdf-preview { background: linear-gradient(145deg, #f8fafc, #e2e8f0); border: 2px solid #e2e8f0; transition: all 0.3s ease; }
        .pdf-preview:hover { border-color: #3b82f6; transform: translateY(-2px); }
        .pdf-preview.approved { border-color: #10b981; background: linear-gradient(145deg, #f0fdf4, #dcfce7); }
        .connector-line { width: 4rem; height: 2px; background: #e2e8f0; }
        .connector-line.completed { background: #10b981; }
        .pricing-card { transition: all 0.3s ease; }
        .pricing-card.popular { transform: scale(1.05); border: 2px solid #3b82f6; box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.15); }
        .pricing-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .pricing-card.popular:hover { transform: translateY(-4px) scale(1.05); }
        .tab-button { transition: all 0.2s ease; }
        .tab-button.active { background: #3b82f6; color: white; }
        .floating-benefit { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        /* For iframe responsiveness, if needed */
        .iframe-container { position: relative; overflow: hidden; width: 100%; padding-top: 141.42%; /* Aspect Ratio 1:sqrt(2) for A4-like */ }
        .iframe-container iframe { position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; border: none; }
    </style>
</head>
<body class="bg-slate-50 font-['Inter','Noto_Sans',sans-serif]">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 2h8v2H6V6zm0 4h8v2H6v-2z"/>
                            </svg>
                        </div>
                        <a href="#" onclick="showTab('hero')" class="text-xl font-bold text-slate-900">PO Wizard</a>
                        <span class="text-sm text-slate-500 hidden sm:inline">Built for Production</span>
                    </div>
                    <div class="flex items-center space-x-6">
                        <nav class="hidden md:flex items-center space-x-6">
                            <button onclick="showTab('features')" class="tab-button px-4 py-2 rounded-lg text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all">Features</button>
                            <button onclick="showTab('pricing')" class="tab-button px-4 py-2 rounded-lg text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all">Pricing</button>
                            <button onclick="showTab('processing')" id="processingNavButton" class="tab-button px-4 py-2 rounded-lg text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all">My POs / Process</button>
                            <span id="connectionStatus" class="hidden items-center space-x-2 text-sm text-green-600">
                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                <span>Connected to Dropbox (Simulated)</span>
                            </span>
                        </nav>
                        <div class="flex items-center space-x-3">
                             <input type="text" id="currentJobNumber" placeholder="Current Job Number" class="hidden md:inline-flex px-3 py-2 border border-slate-300 rounded-lg text-sm" value="85319">
                            <button onclick="showSignIn()" id="signInButton" class="hidden md:inline-flex items-center px-4 py-2 text-slate-600 hover:text-slate-900 transition-colors">
                                Sign In
                            </button>
                            <button onclick="showSignUp()" id="getStartedButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Get Started Free
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1">
            <!-- Hero Section -->
            <section id="heroSection" class="hero-gradient py-16 lg:py-20">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h2 class="text-5xl lg:text-6xl font-bold text-white mb-8 leading-tight">
                            Stop Wrestling with<br/>
                            <span class="text-purple-300">Post-Production Receipts</span>
                        </h2>
                        <p class="text-xl lg:text-2xl text-slate-300 max-w-4xl mx-auto leading-relaxed mb-12">
                            Transform your chaotic pile of vendor invoices, receipts, and credit card statements into professional purchase orders in minutes, not hours. Built specifically for <strong>production coordinators</strong> tired of manual PO creation.
                        </p>
                        
                        <div class="grid md:grid-cols-2 gap-12 max-w-5xl mx-auto mb-16">
                            <div class="bg-red-500/10 backdrop-blur-sm rounded-2xl p-8 border border-red-300/20">
                                <div class="text-red-300 mb-4"><span class="material-icons-outlined text-4xl">warning</span></div>
                                <h3 class="text-xl font-bold text-white mb-4">The Old Way</h3>
                                <ul class="text-slate-300 space-y-2 text-left">
                                    <li>• Hours manually entering vendor data</li><li>• Hunting through receipts and invoices</li><li>• Formatting POs one by one</li><li>• Missing deadlines for production companies</li><li>• Losing track of expenses</li>
                                </ul>
                            </div>
                            <div class="bg-green-500/10 backdrop-blur-sm rounded-2xl p-8 border border-green-300/20">
                                <div class="text-green-300 mb-4"><span class="material-icons-outlined text-4xl">auto_awesome</span></div>
                                <h3 class="text-xl font-bold text-white mb-4">The PO Wizard Way</h3>
                                <ul class="text-slate-300 space-y-2 text-left">
                                    <li>• AI scans all your documents automatically</li><li>• Extracts vendor info, amounts, dates</li><li>• Generates professional POs instantly</li><li>• Ready for production company submission</li><li>• Complete audit trail maintained</li>
                                </ul>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-6">
                            <button onclick="showSignUp()" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-bold py-4 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-200 text-lg">
                                Start Free Trial - Process 5 Vendors
                            </button>
                            <button onclick="showTab('features')" class="bg-white/10 backdrop-blur-sm hover:bg-white/20 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-200 border border-white/20">
                                See How It Works
                            </button>
                        </div>
                        <p class="text-slate-400 mt-6 text-sm">No credit card required • 2-minute setup • Works with any production size</p>
                    </div>
                    <div class="text-center">
                        <p class="text-slate-400 text-sm mb-6">Trusted by Production Coordinators at:</p>
                        <div class="flex justify-center items-center space-x-12 opacity-60">
                            <div class="text-white font-bold text-lg">Netflix</div><div class="text-white font-bold text-lg">HBO</div><div class="text-white font-bold text-lg">Warner Bros</div><div class="text-white font-bold text-lg">A24</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <section id="featuresSection" class="py-20 bg-white hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h3 class="text-4xl font-bold text-slate-900 mb-6">How PO Wizard Works</h3>
                        <p class="text-xl text-slate-600 max-w-3xl mx-auto">Three simple steps to transform your post-production chaos into organized, professional purchase orders</p>
                    </div>
                    <div class="grid lg:grid-cols-3 gap-12 mb-20">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-3xl font-bold text-blue-600">1</span></div>
                            <h4 class="text-xl font-bold text-slate-900 mb-4">Upload Your Mess</h4>
                            <p class="text-slate-600 mb-6">Connect your Dropbox or upload folders full of vendor invoices, receipts, credit card statements, and random charges from your production.</p>
                            <div class="bg-slate-50 rounded-xl p-6">
                                <div class="flex justify-center space-x-4 mb-4">
                                    <div class="w-12 h-16 bg-red-100 rounded border-2 border-red-200 flex items-center justify-center"><span class="material-icons-outlined text-red-600 text-sm">receipt</span></div>
                                    <div class="w-12 h-16 bg-blue-100 rounded border-2 border-blue-200 flex items-center justify-center"><span class="material-icons-outlined text-blue-600 text-sm">description</span></div>
                                    <div class="w-12 h-16 bg-green-100 rounded border-2 border-green-200 flex items-center justify-center"><span class="material-icons-outlined text-green-600 text-sm">credit_card</span></div>
                                </div><p class="text-xs text-slate-500">Invoices, receipts, credit card statements</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-3xl font-bold text-purple-600">2</span></div>
                            <h4 class="text-xl font-bold text-slate-900 mb-4">AI Works Its Magic</h4>
                            <p class="text-slate-600 mb-6">Our AI scans every document, extracts vendor information, amounts, dates, and categories. No manual data entry required.</p>
                            <div class="bg-slate-50 rounded-xl p-6">
                                <div class="flex justify-center mb-4"><div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center"><span class="material-icons-outlined text-white text-2xl">psychology</span></div></div>
                                <div class="space-y-2"><div class="h-2 bg-gradient-to-r from-purple-200 to-blue-200 rounded animate-pulse"></div><div class="h-2 bg-gradient-to-r from-blue-200 to-purple-200 rounded animate-pulse" style="animation-delay: 0.5s"></div><div class="h-2 bg-gradient-to-r from-purple-200 to-blue-200 rounded animate-pulse" style="animation-delay: 1s"></div></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-3xl font-bold text-green-600">3</span></div>
                            <h4 class="text-xl font-bold text-slate-900 mb-4">Perfect POs Delivered</h4>
                            <p class="text-slate-600 mb-6">Get professionally formatted purchase orders ready for production company submission. Review, approve, and download in minutes.</p>
                            <div class="bg-slate-50 rounded-xl p-6">
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="h-20 bg-white rounded-lg border-2 border-green-200 p-2"><div class="h-2 bg-green-200 rounded mb-1"></div><div class="h-2 bg-green-100 rounded mb-1"></div><div class="h-2 bg-green-100 rounded"></div><div class="text-xs text-green-600 mt-2 font-medium">PO-001</div></div>
                                    <div class="h-20 bg-white rounded-lg border-2 border-green-200 p-2"><div class="h-2 bg-green-200 rounded mb-1"></div><div class="h-2 bg-green-100 rounded mb-1"></div><div class="h-2 bg-green-100 rounded"></div><div class="text-xs text-green-600 mt-2 font-medium">PO-002</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <div class="text-center floating-benefit"><div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-blue-600 text-2xl">schedule</span></div><h4 class="font-bold text-slate-900 mb-2">Save 10+ Hours</h4><p class="text-slate-600 text-sm">Per production wrap</p></div>
                        <div class="text-center floating-benefit" style="animation-delay: 1s"><div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-green-600 text-2xl">check_circle</span></div><h4 class="font-bold text-slate-900 mb-2">99% Accuracy</h4><p class="text-slate-600 text-sm">AI-powered extraction</p></div>
                        <div class="text-center floating-benefit" style="animation-delay: 2s"><div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-purple-600 text-2xl">trending_up</span></div><h4 class="font-bold text-slate-900 mb-2">Faster Payments</h4><p class="text-slate-600 text-sm">Professional formatting</p></div>
                        <div class="text-center floating-benefit" style="animation-delay: 3s"><div class="w-16 h-16 bg-yellow-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="material-icons-outlined text-yellow-600 text-2xl">security</span></div><h4 class="font-bold text-slate-900 mb-2">Audit Trail</h4><p class="text-slate-600 text-sm">Complete documentation</p></div>
                    </div>
                </div>
            </section>

            <!-- Pricing Section -->
            <section id="pricingSection" class="py-20 bg-slate-50 hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h3 class="text-4xl font-bold text-slate-900 mb-6">Simple, Transparent Pricing</h3>
                        <p class="text-xl text-slate-600 max-w-3xl mx-auto">Choose the plan that fits your production workflow. Start free, upgrade as you grow.</p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                        <div class="pricing-card bg-white rounded-2xl p-8 shadow-lg">
                            <div class="text-center mb-8"><h4 class="text-2xl font-bold text-slate-900 mb-2">Free</h4><p class="text-slate-600 mb-6">Perfect for small productions</p><div class="text-4xl font-bold text-slate-900 mb-2">Free</div><p class="text-slate-500 text-sm">No credit card required</p></div>
                            <ul class="space-y-4 mb-8">
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Up to 5 vendors per production</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Single production processing</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Basic AI scanning</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Standard PO templates</span></li>
                            </ul><button onclick="showSignUp('free')" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-xl transition-colors">Get Started Free</button>
                        </div>
                        <div class="pricing-card popular bg-white rounded-2xl p-8 shadow-xl relative">
                            <div class="absolute -top-4 left-1/2 transform -translate-x-1/2"><span class="bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-medium">Most Popular</span></div>
                            <div class="text-center mb-8"><h4 class="text-2xl font-bold text-slate-900 mb-2">Pro</h4><p class="text-slate-600 mb-6">For growing productions</p><div class="text-4xl font-bold text-slate-900 mb-2">$20</div><p class="text-slate-500 text-sm">per month</p></div>
                            <ul class="space-y-4 mb-8">
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited vendors</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited production amounts</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited iterations on 1 production</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Advanced AI with 99% accuracy</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Custom PO templates</span></li>
                            </ul><button onclick="showSignUp('pro')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors">Start Free Trial</button>
                        </div>
                        <div class="pricing-card bg-white rounded-2xl p-8 shadow-lg">
                            <div class="text-center mb-8"><h4 class="text-2xl font-bold text-slate-900 mb-2">Enterprise</h4><p class="text-slate-600 mb-6">For production companies</p><div class="text-4xl font-bold text-slate-900 mb-2">$30</div><p class="text-slate-500 text-sm">per month</p></div>
                            <ul class="space-y-4 mb-8">
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited productions</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Unlimited vendors</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Cross-tracking between productions</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Microsoft Excel integration</span></li>
                                <li class="flex items-center"><span class="material-icons-outlined text-green-500 mr-3">check</span><span class="text-slate-700">Fully custom, unbranded designs</span></li>
                            </ul><button onclick="showSignUp('enterprise')" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors">Contact Sales</button>
                        </div>
                    </div>
                    <div class="text-center mt-12">
                        <p class="text-slate-600 mb-4">All plans include 14-day free trial • No setup fees • Cancel anytime</p>
                        <div class="flex justify-center items-center space-x-6 text-sm text-slate-500">
                            <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">security</span>Bank-grade security</span>
                            <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">support</span>24/7 support</span>
                            <span class="flex items-center"><span class="material-icons-outlined text-green-500 mr-1 text-sm">cloud_upload</span>99.9% uptime</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Processing Section (Hidden by default, shown after "sign in/up") -->
            <section id="processingSection" class="hero-gradient py-16 lg:py-20 hidden">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <div class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8 lg:p-12 max-w-4xl mx-auto">
                        <!-- Step Indicators (can be simplified or enhanced later) -->
                        <div id="jobContextDisplay" class="mb-6 text-slate-700">
                            Job: <span id="displayJobNumber" class="font-semibold">N/A</span> | 
                            Project: <span id="displayProjectName" class="font-semibold">N/A</span>
                        </div>
                        
                        <div class="flex justify-center items-center space-x-8 mb-12">
                             <div id="step1Indicator" class="flex flex-col items-center">
                                <div class="w-12 h-12 bg-slate-300 rounded-full flex items-center justify-center text-slate-500 font-bold text-lg mb-3 transition-all duration-300">1</div>
                                <span class="text-sm font-medium text-slate-500">Configure Job</span>
                            </div>
                            <div id="step2Indicator" class="flex flex-col items-center">
                                <div class="w-12 h-12 bg-slate-300 rounded-full flex items-center justify-center text-slate-500 font-bold text-lg mb-3 transition-all duration-300">2</div>
                                <span class="text-sm font-medium text-slate-500">Process Documents</span>
                            </div>
                        </div>

                        <!-- Step 1: Job Configuration (Dropbox Paths) -->
                        <div id="step1" class="step-content">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 bg-blue-100 rounded-3xl flex items-center justify-center mx-auto mb-6">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.015-3.569-1.156-.503.325-.808.817-.808 1.331 0 .694.521 1.304 1.25 1.304.188 0 .375-.047.551-.132l.812.812c-.387.226-.808.363-1.25.363-1.279 0-2.344-1.117-2.344-2.5 0-.691.279-1.328.775-1.791.871-.814 2.079-1.076 3.146-.805l1.397-1.397c.094-.094.219-.156.344-.156.281 0 .531.219.531.5 0 .125-.062.25-.156.344l-8.687 8.687c-.094.094-.219.156-.344-.156-.281 0-.531-.219-.531-.5 0-.125.062.25.156.344l3.344-3.344z"/></svg>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-900 mb-4">Configure Dropbox Processing</h3>
                                <p class="text-slate-600 max-w-lg mx-auto mb-8">
                                    Enter the Dropbox paths for your source documents and where generated POs should be saved.
                                    Ensure your Job Number is set in the header.
                                </p>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="dropboxSourcePath" class="block text-sm font-medium text-slate-700 text-left mb-1">Dropbox Source Path (Vendor Folders):</label>
                                    <input type="text" id="dropboxSourcePath" value="/POWizardCompany/Development/SourceDocuments_85319" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="dropboxOutputPath" class="block text-sm font-medium text-slate-700 text-left mb-1">Dropbox Output Path (Generated POs):</label>
                                    <input type="text" id="dropboxOutputPath" value="/POWizardCompany/Development/GeneratedPOs_85319" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <button onclick="confirmPathsAndProceed()" id="confirmPathsButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-xl transition-all">
                                Confirm Paths & Proceed to Process
                            </button>
                            <div class="text-xs text-slate-500 text-center mt-4">
                                <span class="material-icons-outlined text-green-600 text-sm mr-1">lock</span>
                                Secure connection via backend.
                            </div>
                        </div>

                        <!-- Step 2: Process Documents (Hidden Initially) -->
                        <div id="step2" class="step-content hidden">
                             <div class="text-center mb-8">
                                <div class="w-20 h-20 bg-green-100 rounded-3xl flex items-center justify-center mx-auto mb-6"><span class="material-icons-outlined text-green-600 text-3xl">auto_awesome</span></div>
                                <h3 class="text-2xl font-bold text-slate-900 mb-4">Processing Documents...</h3>
                                <p class="text-slate-600 max-w-lg mx-auto mb-8" id="processingStatusText">
                                    AI is scanning your Dropbox folder, extracting data, and generating purchase orders. This may take several minutes depending on the number of documents.
                                </p>
                            </div>
                            <!-- Progress Section (Hidden Initially) -->
                            <div id="progressSection" class="progress-section"> <!-- Initially hidden via class, expanded by JS -->
                                <div class="border-t border-slate-200 pt-8">
                                    <div class="mb-6">
                                        <div class="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
                                            <div id="progressFill" class="h-full bg-gradient-to-r from-green-500 to-blue-500 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between items-center mt-3">
                                            <span id="progressPercent" class="text-sm font-semibold text-slate-700">0%</span>
                                            <span id="estimatedTime" class="text-xs text-slate-500">Calculating...</span>
                                        </div>
                                    </div>
                                    <div class="bg-slate-50 rounded-xl p-6 text-center">
                                        <div class="flex items-center justify-center space-x-2 mb-3">
                                            <h4 id="stageTitle" class="text-lg font-semibold text-slate-900">Initializing...</h4>
                                            <div id="stageSpinner" class="w-4 h-4 border-2 border-slate-300 border-t-blue-600 rounded-full animate-spin"></div>
                                        </div>
                                        <p id="stageDescription" class="text-slate-600 text-sm">Preparing to process your documents.</p>
                                    </div>
                                    <button onclick="cancelProcessing()" id="cancelProcessingButton" class="mt-6 w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-3 px-6 rounded-xl transition-colors duration-200">
                                        Cancel Processing (Not Implemented)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Generated Purchase Orders Section -->
            <section id="purchaseOrdersSection" class="py-16 bg-white hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold text-slate-900 mb-2">Generated Purchase Orders</h3>
                            <p class="text-slate-600" id="currentJobDisplayPOs">Review your generated POs before submission</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="poCount" class="text-sm text-slate-600">0 POs Generated</span>
                            <button class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-medium transition-colors" title="Functionality not yet implemented" disabled>
                                <span class="flex items-center space-x-2"><span class="material-icons-outlined text-sm">download</span><span>Download All (Soon)</span></span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4 mb-8 flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center space-x-4">
                            <select id="filterStatus" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm"><option value="all">All Status</option><option value="pending">Pending Review</option><option value="approved">Approved</option></select>
                            <input type="text" id="filterVendorName" placeholder="Filter by Vendor Name..." class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-slate-600">Sort by:</span>
                            <select id="sortPOs" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm">
                                <option value="date">Date Created</option><option value="vendor">Vendor Name</option><option value="amount">Amount</option><option value="status">Status</option>
                            </select>
                        </div>
                    </div>
                    <div id="poGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- PO Cards will be populated here -->
                         <p id="noPOsMessage" class="text-slate-500 col-span-full text-center hidden">No purchase orders generated yet for this job, or an error occurred.</p>
                    </div>
                    <!-- Pagination (Simplified for now) -->
                    <div id="paginationControls" class="flex justify-center items-center space-x-4 mt-12 hidden">
                        <button class="p-2 hover:bg-slate-100 rounded-lg transition-colors"><span class="material-icons-outlined">chevron_left</span></button>
                        <div class="flex space-x-1"><button class="px-3 py-2 bg-blue-600 text-white rounded-lg">1</button></div>
                        <button class="p-2 hover:bg-slate-100 rounded-lg transition-colors"><span class="material-icons-outlined">chevron_right</span></button>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-slate-800 text-slate-300">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center space-x-3 mb-4 md:mb-0">
                        <div class="w-6 h-6 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 2h8v2H6V6zm0 4h8v2H6v-2z"/></svg>
                        </div>
                        <span class="font-bold">PO Wizard</span><span class="text-slate-400">for Film Production</span>
                    </div>
                    <div class="text-center"><p class="text-slate-400 text-sm">Streamlining post-production workflows since 2024</p></div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Review PO Modal -->
    <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100]"> <!-- Increased z-index -->
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-6xl w-11/12 md:w-full mx-auto max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="reviewModalTitle" class="text-2xl font-bold text-slate-900">Review Purchase Order</h3>
                <button onclick="closeReviewModal()" class="text-slate-400 hover:text-slate-600">
                    <span class="material-icons-outlined text-2xl">close</span>
                </button>
            </div>
            <div class="flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-8">
                <div class="w-full lg:w-1/2 iframe-container">
                    <iframe id="pdfViewer" src="about:blank" title="PO PDF"></iframe>
                </div>
                <div class="w-full lg:w-1/2">
                    <form id="reviewForm" class="space-y-4">
                        <input type="hidden" id="editPoIdOnGrid">
                        <input type="hidden" id="editOriginalPoPackageFilename">
                        <input type="hidden" id="editBackupDocsPaths" name="backup_document_original_dropbox_paths"> <!-- Store as JSON string -->


                        <div><label for="editPoNumber" class="block text-sm font-medium text-slate-700 mb-1">PO Number</label><input type="text" id="editPoNumber" name="po_number" class="w-full form-input" readonly></div>
                        <div><label for="editVendor" class="block text-sm font-medium text-slate-700 mb-1">Vendor Name</label><input type="text" id="editVendor" name="vendor_name" class="w-full form-input"></div>
                        <div><label for="editVendorAddress" class="block text-sm font-medium text-slate-700 mb-1">Vendor Address</label><textarea id="editVendorAddress" name="vendor_address" rows="2" class="w-full form-textarea"></textarea></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="editVendorTIN" class="block text-sm font-medium text-slate-700 mb-1">Vendor TIN/SSN</label><input type="text" id="editVendorTIN" name="vendor_tin" class="w-full form-input"></div>
                            <div><label for="editPoDate" class="block text-sm font-medium text-slate-700 mb-1">PO Date (MM/DD/YY)</label><input type="text" id="editPoDate" name="po_date" class="w-full form-input"></div>
                        </div>
                         <div class="grid grid-cols-2 gap-4">
                            <div><label for="editHasW9" class="block text-sm font-medium text-slate-700 mb-1">W9 on File?</label><select id="editHasW9" name="has_w9_document" class="w-full form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                            <div><label for="editIsIncorp" class="block text-sm font-medium text-slate-700 mb-1">Incorporated?</label><select id="editIsIncorp" name="is_incorp_on_w9" class="w-full form-select"><option value="Unknown">Unknown</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
                        </div>
                        <div><label for="editInvoiceRef" class="block text-sm font-medium text-slate-700 mb-1">Invoice Reference(s)</label><input type="text" id="editInvoiceRef" name="invoice_reference_from_po" class="w-full form-input"></div>
                        
                        <h4 class="text-md font-semibold text-slate-800 pt-2">Line Items:</h4>
                        <div id="editLineItemsContainer" class="space-y-2 max-h-48 overflow-y-auto border p-2 rounded-md">
                            <!-- Line items will be populated here -->
                        </div>
                        <button type="button" onclick="addLineItemField()" class="text-sm text-blue-600 hover:text-blue-800">+ Add Line Item</button>

                        <div><label for="editTotalAmount" class="block text-sm font-medium text-slate-700 mb-1">Total Amount ($)</label><input type="text" id="editTotalAmount" name="total_vendor_amount_str" class="w-full form-input"></div>
                        <div><label for="editAdditionalNotes" class="block text-sm font-medium text-slate-700 mb-1">Additional Notes</label><textarea id="editAdditionalNotes" name="additional_notes" rows="2" class="w-full form-textarea"></textarea></div>
                        
                        <!-- Hidden fields for context -->
                        <input type="hidden" id="editJobNumber" name="job_number">
                        <input type="hidden" id="editProjectName" name="project_name">

                    </form>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-8">
                <button onclick="submitPOChanges(false)" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-xl font-medium transition-colors">
                    Save Changes & Regenerate PO
                </button>
                 <button onclick="submitPOChanges(true)" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-xl font-medium transition-colors">
                    Approve PO (Future)
                </button>
                <button onclick="closeReviewModal()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 px-6 rounded-xl font-medium transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://po-wizard-backend-private.onrender.com';
        let isAuthenticated = false; // Simple auth flag
        let currentJobNumberContext = "85319"; // Default or from input
        let currentProjectNameContext = "Macy's Holiday Shoot"; // Default
        let currentOpenPOTaskId = null; // For tracking main processing task
        let statusPollInterval = null;
        let allFetchedPOs = []; // Store all POs for current job for client-side filtering/sorting

        // --- Tab Management ---
        function showTab(tabName) {
            document.getElementById('heroSection').style.display = 'none';
            document.getElementById('featuresSection').style.display = 'none';
            document.getElementById('pricingSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('purchaseOrdersSection').style.display = 'none';

            if (tabName === 'hero') document.getElementById('heroSection').style.display = 'block';
            else if (tabName === 'features') document.getElementById('featuresSection').style.display = 'block';
            else if (tabName === 'pricing') document.getElementById('pricingSection').style.display = 'block';
            else if (tabName === 'processing') {
                if (!isAuthenticated) {
                    alert('Please "Sign In" to access processing.');
                    showTab('hero'); return;
                }
                document.getElementById('processingSection').style.display = 'block';
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('progressSection').classList.remove('expanded');
                updateJobContextDisplay();
            } else if (tabName === 'purchaseOrders') {
                 if (!isAuthenticated) {
                    alert('Please "Sign In" to view POs.');
                    showTab('hero'); return;
                }
                document.getElementById('purchaseOrdersSection').style.display = 'block';
                fetchGeneratedPOs(); // Fetch POs when this tab is shown
            }
            updateActiveTabButton(tabName);
        }

        function updateActiveTabButton(activeTab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            const buttonMap = { 'hero': null, 'features': 'Features', 'pricing': 'Pricing', 'processing': 'My POs / Process', 'purchaseOrders': 'My POs / Process'};
            if (buttonMap[activeTab]) {
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if (btn.textContent.trim() === buttonMap[activeTab]) btn.classList.add('active');
                });
            }
        }

        // --- Authentication Simulation ---
        function showSignIn() {
            isAuthenticated = true;
            document.getElementById('signInButton').textContent = 'Signed In';
            document.getElementById('signInButton').disabled = true;
            document.getElementById('getStartedButton').textContent = 'Process New Job';
            document.getElementById('getStartedButton').onclick = () => showTab('processing');
            document.getElementById('currentJobNumber').classList.remove('hidden'); // Show job number input
            currentJobNumberContext = document.getElementById('currentJobNumber').value || "DEFAULT_JOB";
            document.getElementById('connectionStatus').classList.remove('hidden');
            document.getElementById('connectionStatus').classList.add('flex');
            showTab('processing'); // Go to processing tab after sign in
        }
        function showSignUp() { // "Get Started Free" also acts as sign in for now
            showSignIn();
        }
        
        function updateJobContextDisplay() {
            currentJobNumberContext = document.getElementById('currentJobNumber').value || "NOT_SET";
            // For now, project name is hardcoded or could be another input
            // currentProjectNameContext = "Default Project"; 
            document.getElementById('displayJobNumber').textContent = currentJobNumberContext;
            document.getElementById('displayProjectName').textContent = currentProjectNameContext; // You'll need to get this from somewhere
             document.getElementById('currentJobDisplayPOs').textContent = `Job: ${currentJobNumberContext} | Project: ${currentProjectNameContext}`;
        }


        // --- Processing Steps ---
        function confirmPathsAndProceed() {
            updateJobContextDisplay(); // Ensure context is current
            const sourcePath = document.getElementById('dropboxSourcePath').value.trim();
            const outputPath = document.getElementById('dropboxOutputPath').value.trim();

            if (!currentJobNumberContext || currentJobNumberContext === "NOT_SET" || !sourcePath || !outputPath) {
                alert("Job Number (in header), Dropbox Source Path, and Output Path are required.");
                return;
            }
            
            document.getElementById('step1Indicator').querySelector('div').className = 'w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-lg mb-3 transition-all duration-300';
            document.getElementById('step1Indicator').querySelector('div').innerHTML = '✓';
            document.getElementById('step1Indicator').querySelector('span').className = 'text-sm font-medium text-slate-700';


            document.getElementById('step2Indicator').querySelector('div').className = 'w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg mb-3 transition-all duration-300';
            document.getElementById('step2Indicator').querySelector('span').className = 'text-sm font-medium text-slate-700';

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('progressSection').classList.add('expanded');
            startDocumentProcessing(sourcePath, outputPath);
        }
        
        async function startDocumentProcessing(sourcePath, outputPath) {
            updateProgressUI(0, "Initializing job submission...");
            document.getElementById('stageSpinner').style.display = 'block';

            const payload = {
                dropbox_source_path: sourcePath,
                dropbox_output_path: outputPath,
                job_number_context: currentJobNumberContext,
                project_name_context: currentProjectNameContext // Make sure this is set appropriately
            };

            try {
                const response = await fetch(`${API_BASE_URL}/trigger-dropbox-processing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to trigger processing: ${errorData.detail || response.statusText}`);
                }
                const data = await response.json();
                currentOpenPOTaskId = data.task_id;
                updateProgressUI(5, "Job submitted. Waiting for Celery worker...");
                pollTaskStatus(currentOpenPOTaskId);
            } catch (error) {
                console.error('Error starting processing:', error);
                updateProgressUI(0, `Error: ${error.message}`, true);
                document.getElementById('stageSpinner').style.display = 'none';
            }
        }

        function pollTaskStatus(taskId) {
            if (statusPollInterval) clearInterval(statusPollInterval); // Clear existing interval

            statusPollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/task-status/${taskId}`);
                    if (!response.ok) {
                        // If API returns error, stop polling for this task
                        const errorData = await response.json();
                        console.error(`Error fetching task status ${taskId}:`, errorData.detail || response.statusText);
                        updateProgressUI(null, `Error fetching status: ${errorData.detail || response.statusText}`, true);
                        clearInterval(statusPollInterval);
                        document.getElementById('stageSpinner').style.display = 'none';
                        return;
                    }
                    const data = await response.json();
                    
                    let currentStepMessage = data.current_step || data.status;
                    if (data.status === 'PROGRESS' && data.result && data.result.vendor_name) {
                        currentStepMessage = `${data.current_step}: ${data.result.vendor_name}`;
                    } else if (data.status === 'PROGRESS' && data.result && data.result.current_step) {
                        currentStepMessage = data.result.current_step;
                    }


                    updateProgressUI(data.progress_percent, currentStepMessage);

                    if (data.status === 'SUCCESS') {
                        clearInterval(statusPollInterval);
                        updateProgressUI(100, "Processing complete! POs generated.");
                        document.getElementById('stageSpinner').style.display = 'none';
                        // Automatically switch to POs tab
                        showTab('purchaseOrders');
                    } else if (data.status === 'FAILURE') {
                        clearInterval(statusPollInterval);
                        const failureDetails = typeof data.result === 'string' ? data.result : JSON.stringify(data.result);
                        updateProgressUI(null, `Processing failed: ${failureDetails}`, true);
                        document.getElementById('stageSpinner').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error polling task status:', error);
                    updateProgressUI(null, "Error polling status. Check console.", true);
                    clearInterval(statusPollInterval); // Stop polling on network or parse error
                    document.getElementById('stageSpinner').style.display = 'none';
                }
            }, 3000); // Poll every 3 seconds
        }

        function updateProgressUI(percentage, statusText, isError = false) {
            if (percentage !== null) {
                document.getElementById('progressFill').style.width = percentage + '%';
                document.getElementById('progressPercent').textContent = percentage + '%';
            }
            document.getElementById('stageTitle').textContent = isError ? "Error" : "Status";
            document.getElementById('stageDescription').textContent = statusText;
            if (isError) {
                document.getElementById('stageTitle').classList.add('text-red-600');
            } else {
                document.getElementById('stageTitle').classList.remove('text-red-600');
            }
        }
        
        function cancelProcessing() { // Placeholder
            if (statusPollInterval) clearInterval(statusPollInterval);
            console.log("Processing cancellation requested (not fully implemented).");
            updateProgressUI(0, "Processing cancelled by user.", true);
            document.getElementById('stageSpinner').style.display = 'none';
            // Would need backend endpoint to actually cancel Celery task if possible
        }


        // --- Purchase Order Grid ---
        async function fetchGeneratedPOs() {
            updateJobContextDisplay(); // Ensure context is current
            const poGrid = document.getElementById('poGrid');
            const noPOsMessage = document.getElementById('noPOsMessage');
            poGrid.innerHTML = '<p class="text-slate-500 col-span-full text-center">Loading POs...</p>'; // Loading state
            noPOsMessage.classList.add('hidden');

            if (!currentJobNumberContext || currentJobNumberContext === "NOT_SET") {
                poGrid.innerHTML = '<p class="text-red-500 col-span-full text-center">Please set a Job Number in the header to load POs.</p>';
                return;
            }

            try {
                // Pass project name if available, backend can use it or ignore
                const response = await fetch(`${API_BASE_URL}/processed-pos/${currentJobNumberContext}?projectName=${encodeURIComponent(currentProjectNameContext)}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Failed to fetch POs: ${response.statusText}`);
                }
                const data = await response.json();
                allFetchedPOs = data.generated_pos || [];
                document.getElementById('poCount').textContent = `${allFetchedPOs.length} POs Generated`;
                renderPOGrid(allFetchedPOs);

            } catch (error) {
                console.error('Error fetching POs:', error);
                poGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">Error loading POs: ${error.message}</p>`;
                noPOsMessage.classList.remove('hidden');
                noPOsMessage.textContent = `Error loading POs: ${error.message}`;
            }
        }

        function renderPOGrid(posToRender) {
            const poGrid = document.getElementById('poGrid');
            const noPOsMessage = document.getElementById('noPOsMessage');
            poGrid.innerHTML = ''; // Clear previous

            if (!posToRender || posToRender.length === 0) {
                noPOsMessage.classList.remove('hidden');
                noPOsMessage.textContent = 'No purchase orders found for the current filters or job.';
                return;
            }
            noPOsMessage.classList.add('hidden');

            posToRender.forEach(po => {
                const card = createPOCard(po);
                poGrid.appendChild(card);
            });
        }
        
        function createPOCard(po) {
            const card = document.createElement('div');
            card.id = `po-${po.po_id_on_grid}`; // Use po_id_on_grid for unique card ID
            // Status might include "Regenerated", "Pending Review", etc.
            const isApproved = po.status && po.status.toLowerCase().includes('approved');
            card.className = `pdf-preview rounded-xl overflow-hidden ${isApproved ? 'approved' : ''}`;
            
            // Determine status display
            let statusDisplay = po.status || 'Unknown';
            let statusColorClass = 'bg-yellow-100 text-yellow-800'; // Default for pending/unknown
            if (isApproved) {
                statusColorClass = 'bg-green-100 text-green-800';
            } else if (po.status && po.status.toLowerCase().includes('error')) {
                statusColorClass = 'bg-red-100 text-red-800';
            }

            card.innerHTML = `
                <img src="https://via.placeholder.com/300x150.png?text=PO+Preview" alt="PO Thumbnail Placeholder" class="w-full h-32 object-cover">
                <div class="p-4 md:p-6">
                    <div class="flex flex-col h-full">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="text-md md:text-lg font-semibold text-slate-900">${po.po_number}</h4>
                            <span class="px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1 ${statusColorClass}">
                                ${isApproved ? '<span class="material-icons-outlined text-sm">check</span>' : ''}
                                <span>${statusDisplay}</span>
                            </span>
                        </div>
                        <p class="text-sm text-slate-600 mb-1 truncate" title="${po.vendor_name}">${po.vendor_name}</p>
                        <p class="text-lg md:text-xl font-bold text-slate-900 mb-1">${po.total_amount.startsWith('$') ? po.total_amount : '$'+po.total_amount}</p>
                        <p class="text-xs md:text-sm text-slate-500 mb-3">Date: ${po.po_date}</p>
                        <div class="mt-auto flex space-x-2">
                            <button onclick="openReviewModal('${po.po_id_on_grid}')" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 py-2 px-3 rounded-lg font-medium text-sm transition-colors">Review / Edit</button>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }


        // --- Review PO Modal ---
        let currentEditingPOData = null; // Store the full data of the PO being edited

        async function openReviewModal(poIdOnGrid) {
            // poIdOnGrid is likely the PO Number like "JOB001-001"
            console.log("Opening review for PO ID on Grid:", poIdOnGrid);
            const poDataToReview = allFetchedPOs.find(p => p.po_id_on_grid === poIdOnGrid);

            if (!poDataToReview || !poDataToReview.full_po_data_for_review) {
                 try {
                    // If full_po_data_for_review is missing, fetch it from the specific endpoint
                    console.log(`Fetching full data for PO: Job ${currentJobNumberContext}, PO ${poIdOnGrid}`);
                    const response = await fetch(`${API_BASE_URL}/get-po-data-for-review/${currentJobNumberContext}/${poIdOnGrid}`);
                    if (!response.ok) {
                        const errorDetail = await response.json();
                        alert(`Error fetching PO details: ${errorDetail.detail || response.statusText}`);
                        return;
                    }
                    currentEditingPOData = await response.json();
                } catch (error) {
                    alert(`Error fetching PO details: ${error.message}`);
                    console.error("Fetch error for PO details:", error);
                    return;
                }
            } else {
                 currentEditingPOData = poDataToReview.full_po_data_for_review;
            }
            
            if (!currentEditingPOData) {
                alert('Could not load data for this PO.');
                return;
            }

            document.getElementById('reviewModalTitle').textContent = `Review Purchase Order: ${currentEditingPOData.po_number}`;
            
            // Populate form fields
            document.getElementById('editPoIdOnGrid').value = poIdOnGrid; // Store for submission
            document.getElementById('editOriginalPoPackageFilename').value = currentEditingPOData.original_po_package_filename;
            document.getElementById('editPoNumber').value = currentEditingPOData.po_number;
            document.getElementById('editVendor').value = currentEditingPOData.vendor_name;
            document.getElementById('editVendorAddress').value = currentEditingPOData.vendor_address || '';
            document.getElementById('editVendorTIN').value = currentEditingPOData.vendor_tin || '';
            document.getElementById('editPoDate').value = currentEditingPOData.po_date; // Ensure format matches what backend expects or reformat
            document.getElementById('editHasW9').value = String(currentEditingPOData.has_w9_document || false);
            document.getElementById('editIsIncorp').value = currentEditingPOData.is_incorp_on_w9 || 'Unknown';
            document.getElementById('editInvoiceRef').value = currentEditingPOData.invoice_reference_from_po || '';
            document.getElementById('editTotalAmount').value = currentEditingPOData.total_vendor_amount_str.replace('$', '');
            document.getElementById('editAdditionalNotes').value = currentEditingPOData.additional_notes || '';
            
            // Populate hidden context fields
            document.getElementById('editJobNumber').value = currentEditingPOData.job_number;
            document.getElementById('editProjectName').value = currentEditingPOData.project_name;

            // Store backup document paths (as JSON string in a hidden input)
            document.getElementById('editBackupDocsPaths').value = JSON.stringify(currentEditingPOData.backup_document_original_dropbox_paths || []);


            // Populate line items
            const lineItemsContainer = document.getElementById('editLineItemsContainer');
            lineItemsContainer.innerHTML = ''; // Clear previous
            if (currentEditingPOData.aggregated_line_items && currentEditingPOData.aggregated_line_items.length > 0) {
                currentEditingPOData.aggregated_line_items.forEach((item, index) => {
                    addLineItemField(item);
                });
            } else {
                // Add one empty line item if none exist
                addLineItemField();
            }


            // Load PDF - use Dropbox link if available and valid
            let pdfSrc = 'about:blank';
            if (currentEditingPOData.generated_draft_po_pdf_path_dropbox) {
                // Ensure it's a direct link if from Dropbox (e.g., ending with ?dl=1)
                let dbxLink = currentEditingPOData.generated_draft_po_pdf_path_dropbox;
                if (dbxLink.startsWith("DROPBOX:")) dbxLink = dbxLink.substring(8); // Remove prefix if present
                // For Dropbox, direct rendering often needs `raw=1` instead of `dl=1` for iframes
                 if (dbxLink.includes("dropbox.com") && !dbxLink.includes("raw=1")) {
                    dbxLink = dbxLink.replace("?dl=0", "?raw=1").replace("dl=0", "raw=1");
                    if (!dbxLink.includes("?raw=1")) dbxLink += "?raw=1";
                }
                pdfSrc = dbxLink;
            } else if (currentEditingPOData.generated_draft_po_pdf_path_local) {
                // For local files, this is tricky. Browser won't load file:// paths for security.
                // Backend would need to serve this file. For now, show placeholder or message.
                console.warn("Local PDF path provided, but direct iframe loading is restricted. Consider serving via backend.");
                pdfSrc = 'about:blank'; // Or a placeholder page
                 alert("PDF preview for local files is not directly supported. Using Dropbox link if available or blank.")
            }
             console.log("Setting PDF viewer src to:", pdfSrc);
            document.getElementById('pdfViewer').src = pdfSrc;
            
            document.getElementById('reviewModal').classList.remove('hidden');
            document.getElementById('reviewModal').classList.add('flex');
        }
        
        function addLineItemField(item = { description: '', budget_code: '', quantity: '1', unit_price: '', amount: '' }) {
            const container = document.getElementById('editLineItemsContainer');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-10 gap-2 items-center';
            div.innerHTML = `
                <input type="text" name="line_items[${index}][description]" value="${item.description || ''}" placeholder="Description" class="col-span-4 form-input text-sm p-1">
                <input type="text" name="line_items[${index}][budget_code]" value="${item.budget_code || ''}" placeholder="Budget Code" class="col-span-2 form-input text-sm p-1">
                <input type="text" name="line_items[${index}][quantity]" value="${item.quantity || '1'}" placeholder="Qty" class="col-span-1 form-input text-sm p-1">
                <input type="text" name="line_items[${index}][unit_price]" value="${item.unit_price || ''}" placeholder="Unit Price" class="col-span-1 form-input text-sm p-1 line-item-calc">
                <input type="text" name="line_items[${index}][amount]" value="${item.amount || ''}" placeholder="Amount" class="col-span-1 form-input text-sm p-1 line-item-calc">
                <button type="button" onclick="removeLineItem(this)" class="col-span-1 text-red-500 hover:text-red-700 text-sm p-1">Remove</button>
            `;
            container.appendChild(div);
             // Add event listeners for dynamic calculation (optional)
            div.querySelectorAll('.line-item-calc').forEach(input => {
                input.addEventListener('input', updateTotalAmountFromLines);
            });
        }

        function removeLineItem(button) {
            button.parentElement.remove();
            updateTotalAmountFromLines();
        }
        
        function updateTotalAmountFromLines() {
            let total = 0;
            document.querySelectorAll('#editLineItemsContainer > div').forEach(lineDiv => {
                const amountInput = lineDiv.querySelector('input[name*="[amount]"]');
                const val = parseFloat(amountInput.value.replace('$', ''));
                if (!isNaN(val)) {
                    total += val;
                }
            });
            document.getElementById('editTotalAmount').value = total.toFixed(2);
        }


        function closeReviewModal() {
            document.getElementById('reviewModal').classList.add('hidden');
            document.getElementById('reviewModal').classList.remove('flex');
            document.getElementById('pdfViewer').src = 'about:blank'; // Clear iframe
            currentEditingPOData = null;
        }

        async function submitPOChanges(isApproval) {
            // Collect data from the form
            const form = document.getElementById('reviewForm');
            const formData = new FormData(form);
            const poDataForRegen = {};

            // Convert FormData to a nested object structure for JSON
            formData.forEach((value, key) => {
                // Handle line items array
                if (key.startsWith('line_items[')) {
                    const match = key.match(/line_items\[(\d+)\]\[(\w+)\]/);
                    if (match) {
                        const index = parseInt(match[1]);
                        const field = match[2];
                        if (!poDataForRegen.aggregated_line_items) {
                            poDataForRegen.aggregated_line_items = [];
                        }
                        while (poDataForRegen.aggregated_line_items.length <= index) {
                            poDataForRegen.aggregated_line_items.push({});
                        }
                        // Ensure amounts are strings, as per schema
                        if (field === 'amount' || field === 'unit_price') {
                             poDataForRegen.aggregated_line_items[index][field] = String(value).replace('$', '');
                        } else {
                             poDataForRegen.aggregated_line_items[index][field] = value;
                        }
                    }
                } else {
                    // Handle boolean strings for has_w9_document
                    if (key === 'has_w9_document') {
                        poDataForRegen[key] = value === 'true';
                    } else {
                         poDataForRegen[key] = value;
                    }
                }
            });
            // Add fields not directly part of form iteration but stored elsewhere
            poDataForRegen.original_po_package_filename = document.getElementById('editOriginalPoPackageFilename').value;
            poDataForRegen.job_number = document.getElementById('editJobNumber').value;
            poDataForRegen.project_name = document.getElementById('editProjectName').value;
            
            // Retrieve and parse backup document paths
            try {
                poDataForRegen.backup_document_original_dropbox_paths = JSON.parse(document.getElementById('editBackupDocsPaths').value || "[]");
            } catch (e) {
                poDataForRegen.backup_document_original_dropbox_paths = [];
                console.error("Error parsing backup_document_original_dropbox_paths:", e);
            }


             // Clean up line items (remove empty ones if any were added but not filled)
            if (poDataForRegen.aggregated_line_items) {
                poDataForRegen.aggregated_line_items = poDataForRegen.aggregated_line_items.filter(item => 
                    item.description || item.amount // Keep if it has at least a description or amount
                );
            }


            if (isApproval) {
                alert("PO Approval functionality is planned for a future update. For now, regenerating the PO with current data.");
                // In future, this might just update status in GSheet without regeneration if no data changed.
                // For now, treat as "Save Changes & Regenerate"
            }
            
            console.log("Submitting PO Data for Regeneration:", poDataForRegen);

            try {
                const response = await fetch(`${API_BASE_URL}/regenerate-po`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ po_data_to_regenerate: poDataForRegen })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Failed to regenerate PO: ${response.statusText}`);
                }
                const updatedPOInfo = await response.json();
                alert('PO successfully regenerated and updated!');
                closeReviewModal();
                // Refresh the PO grid to show updated info
                fetchGeneratedPOs(); 
            } catch (error) {
                console.error('Error submitting PO changes:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // --- Filters and Sorts for PO Grid ---
        document.getElementById('filterStatus').addEventListener('change', applyFiltersAndSort);
        document.getElementById('filterVendorName').addEventListener('input', applyFiltersAndSort);
        document.getElementById('sortPOs').addEventListener('change', applyFiltersAndSort);

        function applyFiltersAndSort() {
            let filteredPOs = [...allFetchedPOs];
            const statusFilter = document.getElementById('filterStatus').value;
            const vendorNameFilter = document.getElementById('filterVendorName').value.toLowerCase();
            const sortBy = document.getElementById('sortPOs').value;

            // Apply status filter
            if (statusFilter !== 'all') {
                filteredPOs = filteredPOs.filter(po => po.status && po.status.toLowerCase().includes(statusFilter));
            }

            // Apply vendor name filter
            if (vendorNameFilter) {
                filteredPOs = filteredPOs.filter(po => po.vendor_name && po.vendor_name.toLowerCase().includes(vendorNameFilter));
            }

            // Apply sort
            switch (sortBy) {
                case 'date': // Assuming po_date is MM/DD/YY - convert for proper sort
                    filteredPOs.sort((a, b) => new Date(a.po_date) - new Date(b.po_date));
                    break;
                case 'vendor':
                    filteredPOs.sort((a, b) => a.vendor_name.localeCompare(b.vendor_name));
                    break;
                case 'amount': // Assuming total_amount is like "$1,234.56"
                    filteredPOs.sort((a, b) => parseFloat(a.total_amount.replace('$', '').replace(',', '')) - parseFloat(b.total_amount.replace('$', '').replace(',', '')));
                    break;
                case 'status':
                    filteredPOs.sort((a, b) => (a.status || "").localeCompare(b.status || ""));
                    break;
            }
            renderPOGrid(filteredPOs);
        }


        // Initial setup
        showTab('hero');
        document.getElementById('currentJobNumber').addEventListener('change', () => {
            currentJobNumberContext = document.getElementById('currentJobNumber').value;
            updateJobContextDisplay();
            if (document.getElementById('purchaseOrdersSection').style.display === 'block') {
                fetchGeneratedPOs(); // Reload POs if job number changes while POs tab is active
            }
        });
        updateJobContextDisplay(); // Set initial display based on default job#

    </script>
</body>
</html>
